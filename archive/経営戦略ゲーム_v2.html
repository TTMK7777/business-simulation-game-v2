<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ³ãƒ‘ã‚¤ã‚¢ - çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            min-height: 100vh;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.3);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .company-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 6px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .date { font-size: 13px; opacity: 0.95; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.15);
        }

        .status-item {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .status-item:active {
            transform: scale(0.95);
        }

        .status-label {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3ã‚¿ãƒ–ï¼‰ */
        .tabs {
            display: flex;
            padding: 0;
            gap: 0;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .tab {
            flex: 1;
            padding: 14px 10px;
            background: #e8e8e8;
            border: none;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 1px solid #d0d0d0;
            position: relative;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            padding: 16px;
            min-height: calc(100vh - 200px);
            background: white;
        }

        .panel { display: none; }
        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:active {
            transform: translateX(2px);
        }

        .card-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #333;
        }

        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ */
        .news-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid #667eea;
            cursor: pointer;
        }

        .news-card:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(0,0,0,0.16);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .news-category {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .news-time {
            font-size: 11px;
            color: #999;
        }

        .news-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .news-summary {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .news-footer {
            display: flex;
            gap: 12px;
        }

        .news-action {
            flex: 1;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .news-action:active {
            transform: scale(0.95);
            background: rgba(102, 126, 234, 0.2);
        }

        /* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµŒå–¶ã‚¿ãƒ–ï¼‰ */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            text-align: center;
        }

        .action-btn:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }

        .action-btn:disabled {
            background: linear-gradient(135deg, #b0b0b0, #888);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .action-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 6px;
        }

        /* ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container {
            margin: 16px 0;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            height: 220px;
        }

        .chart-title {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        /* ç«¶åˆä¼æ¥­ã‚«ãƒ¼ãƒ‰ */
        .competitor-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            padding: 14px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
            transition: transform 0.2s;
        }

        .competitor-card:active {
            transform: translateX(4px);
        }

        .competitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .competitor-name {
            font-weight: bold;
            font-size: 16px;
        }

        .competitor-share {
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .competitor-info {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        /* å¾“æ¥­å“¡ãƒ»è£½å“ã‚«ãƒ¼ãƒ‰ */
        .employee-card, .product-card {
            background: #f8f9fa;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }

        .employee-name, .product-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .employee-stats, .product-stats {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 12px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: scale(0.97);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #b0b0b0, #888);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 20px;
            max-width: 360px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #667eea;
        }

        .modal-close {
            width: 100%;
            padding: 12px;
            background: #e0e0e0;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            margin-top: 16px;
            cursor: pointer;
        }

        .modal-close:active {
            transform: scale(0.98);
            background: #d0d0d0;
        }

        .empty {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.5s ease;
        }

        /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
        .info-box {
            background: #f8f9fa;
            padding: 14px;
            border-radius: 10px;
            margin: 12px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #666;
        }

        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º */
        .ranking-bar {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 12px;
            display: flex;
            justify-content: space-around;
            font-size: 11px;
            gap: 6px;
        }

        .rank-item {
            text-align: center;
            padding: 10px 6px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            transition: transform 0.2s;
        }

        .rank-item:active {
            transform: translateY(-2px);
        }

        .rank-item.player {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
        }

        .rank-medal {
            font-size: 18px;
            display: block;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div class="company-name">ğŸ¢ æ ªå¼ä¼šç¤¾ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—</div>
            <div class="date" id="gameDate">2025å¹´1æœˆ ç¬¬1é€±</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-label">ğŸ’° è³‡é‡‘</div>
                    <div class="status-value" id="money">1000ä¸‡</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ‘¥ å¾“æ¥­å“¡</div>
                    <div class="status-value" id="employeeCount">1</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ“Š å£²ä¸Š</div>
                    <div class="status-value" id="revenue">0ä¸‡</div>
                </div>
                <div class="status-item">
                    <div class="status-label">â­ ãƒ–ãƒ©ãƒ³ãƒ‰</div>
                    <div class="status-value" id="brand">1</div>
                </div>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º -->
        <div class="ranking-bar" id="rankingBar"></div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3ã‚¿ãƒ–ï¼‰ -->
        <div class="tabs">
            <button class="tab active" onclick="showPanel('management')">ğŸ¢ çµŒå–¶</button>
            <button class="tab" onclick="showPanel('news')">ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹</button>
            <button class="tab" onclick="showPanel('industry')">ğŸ“Š æ¥­ç•Œ</button>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="content">
            <!-- ğŸ¢ çµŒå–¶ã‚¿ãƒ– -->
            <div id="management" class="panel active">
                <div class="section-title">ğŸ“ˆ ä¼šç¤¾æ¦‚è¦</div>
                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">æ¥­ç•Œ</span>
                        <span class="info-value">ITãƒ»ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¸‚å ´ã‚·ã‚§ã‚¢</span>
                        <span class="info-value" id="marketShare">0.1%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›</span>
                        <span class="info-value" id="brandPower">â­</span>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š å£²ä¸Šæ¨ç§»</div>
                    <canvas id="revenueChart" height="160"></canvas>
                </div>

                <div class="section-title">ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="quick-actions">
                    <button class="action-btn" data-requires-active="true" onclick="showHiring()">
                        <span class="action-icon">ğŸ‘¥</span>
                        æ¡ç”¨æ´»å‹•
                    </button>
                    <button class="action-btn" data-requires-active="true" onclick="developProduct()">
                        <span class="action-icon">ğŸ“¦</span>
                        è£½å“é–‹ç™º
                    </button>
                    <button class="action-btn" data-requires-active="true" onclick="doMarketing()">
                        <span class="action-icon">ğŸ“¢</span>
                        å–¶æ¥­æ´»å‹•
                    </button>
                    <button class="action-btn" data-requires-active="true" onclick="getLoan()">
                        <span class="action-icon">ğŸ¦</span>
                        éŠ€è¡Œèè³‡
                    </button>
                </div>

                <div class="section-title">ğŸ‘¥ å¾“æ¥­å“¡ï¼ˆæœ€æ–°3åï¼‰</div>
                <div id="employeeListShort"></div>

                <div class="section-title">ğŸ“¦ è£½å“ï¼ˆæœ€æ–°3è£½å“ï¼‰</div>
                <div id="productListShort"></div>

                <button class="btn" data-requires-active="true" onclick="nextTurn()">â­ï¸ æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸</button>
                <button class="btn btn-secondary" data-requires-active="true" onclick="saveGame()">ğŸ’¾ ã‚²ãƒ¼ãƒ ä¿å­˜</button>
                <button class="btn btn-danger" id="restartButton" style="display:none;" onclick="restartGame()">ğŸ”„ ã‚²ãƒ¼ãƒ å†ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>

            <!-- ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ãƒ– -->
            <div id="news" class="panel">
                <div class="section-title">ğŸ“° æ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div id="newsList"></div>
            </div>

            <!-- ğŸ“Š æ¥­ç•Œã‚¿ãƒ– -->
            <div id="industry" class="panel">
                <div class="section-title">ğŸ“Š å¸‚å ´ã‚·ã‚§ã‚¢åˆ†å¸ƒ</div>
                <div class="chart-container">
                    <canvas id="marketChart" height="200"></canvas>
                </div>

                <div class="section-title">ğŸ† ä¼æ¥­ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <div id="competitorList"></div>

                <button class="btn" data-requires-active="true" onclick="doMarketing()">ğŸ“¢ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å®Ÿæ–½</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalBody"></div>
            <button class="modal-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆ
        const defaultGameState = {
            money: 10000000,
            employees: [],
            products: [],
            turn: 1,
            year: 2025,
            month: 1,
            week: 1,
            marketShare: 0.1,
            brandPower: 1,
            monthlyRevenue: 0,
            debt: 0,
            isBankrupt: false,
            revenueHistory: [],
            newsHistory: []
        };

        const LOAN_AMOUNT = 5000000;
        const LOAN_INTEREST_RATE = 0.02;
        const SAVE_KEY = 'businessEmpire_v2';

        const game = cloneDefaults();
        let activePanel = 'management';
        let revenueChart = null;
        let marketChart = null;

        const competitors = [
            { name: 'ãƒ†ãƒƒã‚¯ã‚³ãƒ¼ãƒ—', share: 35, strategy: 'aggressive', power: 100, ceo: 'ç”°ä¸­å¥ä¸€', employees: 850, revenue: 12000000000 },
            { name: 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ¯ãƒ¼ã‚¯ã‚¹', share: 29, strategy: 'balanced', power: 85, ceo: 'éˆ´æœ¨æ™ºå­', employees: 620, revenue: 8500000000 },
            { name: 'ã‚µã‚¤ãƒãƒ¼ã‚½ãƒ•ãƒˆ', share: 22, strategy: 'defensive', power: 70, ceo: 'å±±ç”°å­å¿—', employees: 480, revenue: 6200000000 }
        ];

        // ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        const newsTemplates = [
            { category: 'ğŸ“ˆ å¸‚å ´å‹•å‘', text: 'ITæ¥­ç•Œã«è¿½ã„é¢¨ï¼æ”¿åºœã®DXæ¨é€²ã§å¸‚å ´ãŒ${percent}%æ‹¡å¤§', summary: 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¨é€²ã«ã‚ˆã‚Šã€ITå¸‚å ´ãŒå¤§ããæˆé•·ã—ã¦ã„ã¾ã™ã€‚' },
            { category: 'ğŸ¢ ç«¶åˆæƒ…å ±', text: '${company}ãŒæ–°è£½å“ã‚’ç™ºè¡¨ï¼æ¥­ç•Œã«è¡æ’ƒ', summary: '${company}ãŒé©æ–°çš„ãªæ–°è£½å“ã‚’ãƒªãƒªãƒ¼ã‚¹ã€‚å¸‚å ´ã‚·ã‚§ã‚¢ãŒ2%ä¸Šæ˜‡ã™ã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚' },
            { category: 'âš ï¸ ãƒªã‚¹ã‚¯è­¦å‘Š', text: 'æ™¯æ°—æ¸›é€Ÿã®å…†ã—ã€ITæŠ•è³‡ã«æ…é‡ãƒ ãƒ¼ãƒ‰', summary: 'çµŒæ¸ˆæŒ‡æ¨™ã®æ‚ªåŒ–ã«ã‚ˆã‚Šã€ä¼æ¥­ã®ITæŠ•è³‡ãŒæ¸›é€Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚' },
            { category: 'ğŸ¤– æŠ€è¡“é©æ–°', text: 'AIæŠ€è¡“é©å‘½ï¼ç”ŸæˆAIå¸‚å ´ãŒ${percent}%æ€¥æˆé•·', summary: 'ç”ŸæˆAIæŠ€è¡“ã®é€²åŒ–ã«ã‚ˆã‚Šã€æ–°ãŸãªãƒ“ã‚¸ãƒã‚¹ãƒãƒ£ãƒ³ã‚¹ãŒåºƒãŒã£ã¦ã„ã¾ã™ã€‚' },
            { category: 'ğŸ’¼ äººæå¸‚å ´', text: 'å¤§æ‰‹ä¼æ¥­ãŒITäººæäº‰å¥ªæˆ¦ã‚’æ¿€åŒ–ã€æ¡ç”¨ã‚³ã‚¹ãƒˆä¸Šæ˜‡', summary: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®éœ€è¦ãŒæ€¥å¢—ã—ã€æ¡ç”¨å¸‚å ´ãŒéç†±ã—ã¦ã„ã¾ã™ã€‚' },
            { category: 'ğŸ† æ¥­ç•Œè¡¨å½°', text: '${company}ãŒæ¥­ç•Œè¡¨å½°ã‚’å—è³ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›ãŒå‘ä¸Š', summary: 'å„ªã‚ŒãŸè£½å“é–‹ç™ºã¨çµŒå–¶æˆ¦ç•¥ãŒè©•ä¾¡ã•ã‚Œã€è¡¨å½°ã•ã‚Œã¾ã—ãŸã€‚' }
        ];

        function cloneDefaults() {
            return JSON.parse(JSON.stringify(defaultGameState));
        }

        function overwriteGameState(source) {
            Object.keys(game).forEach(key => delete game[key]);
            Object.assign(game, source);
        }

        function ensureCollections() {
            if (!Array.isArray(game.employees)) game.employees = [];
            if (!Array.isArray(game.products)) game.products = [];
            if (!Array.isArray(game.revenueHistory)) game.revenueHistory = [];
            if (!Array.isArray(game.newsHistory)) game.newsHistory = [];
        }

        function normalizeGameState() {
            ensureCollections();
            game.money = Number(game.money) || 0;
            game.turn = Number(game.turn) || 1;
            game.year = Number(game.year) || 2025;
            game.month = Number(game.month) || 1;
            game.week = Number(game.week) || 1;
            game.marketShare = Number(game.marketShare) || 0;
            game.brandPower = Number(game.brandPower) || 0;
            game.monthlyRevenue = Number(game.monthlyRevenue) || 0;
            game.debt = Math.max(0, Number(game.debt) || 0);
            game.isBankrupt = Boolean(game.isBankrupt);
        }

        function resetGameState() {
            overwriteGameState(cloneDefaults());
            normalizeGameState();
            activePanel = 'management';
        }

        function addInitialEmployee() {
            ensureCollections();
            if (game.employees.length > 0) return;
            const initialEmployee = {
                id: 1,
                name: 'å±±ç”° å¤ªéƒ',
                abilities: { technical: 65, sales: 45 },
                motivation: 75,
                salary: 400000
            };
            game.employees.push(initialEmployee);
        }

        function loadGameFromStorage() {
            try {
                const saved = localStorage.getItem(SAVE_KEY);
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                const merged = Object.assign(cloneDefaults(), parsed);
                overwriteGameState(merged);
                normalizeGameState();
                activePanel = typeof parsed.activePanel === 'string' ? parsed.activePanel : 'management';
                delete game.activePanel;
                return true;
            } catch (error) {
                console.error('Failed to load save data', error);
                return false;
            }
        }

        function init() {
            const loaded = loadGameFromStorage();
            if (!loaded) {
                resetGameState();
                addInitialEmployee();
                generateInitialNews();
            } else {
                normalizeGameState();
                if (game.employees.length === 0) addInitialEmployee();
                if (game.newsHistory.length === 0) generateInitialNews();
            }
            updateDisplay();
            updateRanking();
            initCharts();
            showPanel(activePanel);
        }

        function initCharts() {
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: game.revenueHistory.map((_, i) => `${i + 1}æœˆ`),
                        datasets: [{
                            label: 'å£²ä¸Šï¼ˆä¸‡å††ï¼‰',
                            data: game.revenueHistory.map(r => r / 10000),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            const marketCtx = document.getElementById('marketChart');
            if (marketCtx) {
                updateMarketChart();
            }
        }

        function updateCharts() {
            if (revenueChart) {
                revenueChart.data.labels = game.revenueHistory.map((_, i) => `${i + 1}æœˆ`);
                revenueChart.data.datasets[0].data = game.revenueHistory.map(r => r / 10000);
                revenueChart.update();
            }

            if (activePanel === 'industry') {
                updateMarketChart();
            }
        }

        function updateMarketChart() {
            const marketCtx = document.getElementById('marketChart');
            if (!marketCtx) return;

            if (marketChart) {
                marketChart.destroy();
            }

            const allCompanies = [
                ...competitors.map(c => ({ name: c.name, share: c.share })),
                { name: 'ã‚ãªãŸ', share: game.marketShare }
            ];

            marketChart = new Chart(marketCtx, {
                type: 'doughnut',
                data: {
                    labels: allCompanies.map(c => c.name),
                    datasets: [{
                        data: allCompanies.map(c => c.share),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#ffd700'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”Ÿæˆ
        function generateInitialNews() {
            ensureCollections();
            for (let i = 0; i < 5; i++) {
                generateNews();
            }
        }

        function generateNews() {
            ensureCollections();
            const template = newsTemplates[Math.floor(Math.random() * newsTemplates.length)];
            const company = competitors[Math.floor(Math.random() * competitors.length)].name;
            const percent = Math.floor(Math.random() * 30) + 10;

            const newsItem = {
                id: Date.now() + Math.random(),
                category: template.category,
                title: template.text.replace('${company}', company).replace('${percent}', percent),
                summary: template.summary.replace('${company}', company).replace('${percent}', percent),
                time: `${Math.floor(Math.random() * 60)}åˆ†å‰`,
                turn: game.turn
            };

            game.newsHistory.unshift(newsItem);
            if (game.newsHistory.length > 20) {
                game.newsHistory = game.newsHistory.slice(0, 20);
            }
        }

        function renderNews() {
            const list = document.getElementById('newsList');
            if (game.newsHistory.length === 0) {
                list.innerHTML = '<div class="empty">ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            list.innerHTML = game.newsHistory.map(news => `
                <div class="news-card">
                    <div class="news-header">
                        <span class="news-category">${news.category}</span>
                        <span class="news-time">${news.time}</span>
                    </div>
                    <h3 class="news-title">${news.title}</h3>
                    <p class="news-summary">${news.summary}</p>
                    <div class="news-footer">
                        <button class="news-action">ğŸ‘ ã„ã„ã­</button>
                        <button class="news-action">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</button>
                    </div>
                </div>
            `).join('');
        }

        function updateCompetitors() {
            competitors.forEach(comp => {
                if (game.marketShare > 5) {
                    if (comp.strategy === 'aggressive') {
                        comp.power += 5;
                        generateNews();
                    }
                }
                if (comp.strategy === 'aggressive') {
                    comp.share += Math.random() * 2;
                } else if (comp.strategy === 'defensive') {
                    comp.share -= Math.random();
                }
                comp.share = Math.max(5, Math.min(60, comp.share));
                if (comp.share > 40) {
                    game.marketShare = Math.max(0.1, game.marketShare - 0.2);
                    if (game.brandPower > 1) {
                        game.brandPower--;
                    }
                }
            });
        }

        function updateRanking() {
            const allCompanies = [
                ...competitors.map(c => ({ name: c.name, share: c.share })),
                { name: 'ã‚ãªãŸ', share: game.marketShare, isPlayer: true }
            ].sort((a, b) => b.share - a.share);

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4'];
            const rankingHtml = allCompanies.slice(0, 4).map((company, index) =>
                `<div class="rank-item ${company.isPlayer ? 'player' : ''}">
                    <span class="rank-medal">${medals[index]}</span>
                    ${company.name}<br>(${company.share.toFixed(1)}%)
                </div>`
            ).join('');

            document.getElementById('rankingBar').innerHTML = rankingHtml;
        }

        function showPanel(panelId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));

            document.querySelector(`.tab:nth-child(${panelId === 'management' ? 1 : panelId === 'news' ? 2 : 3})`).classList.add('active');
            document.getElementById(panelId).classList.add('active');

            activePanel = panelId;
            renderActivePanel();
        }

        function renderActivePanel() {
            if (activePanel === 'management') {
                renderEmployeesShort();
                renderProductsShort();
            } else if (activePanel === 'news') {
                renderNews();
            } else if (activePanel === 'industry') {
                renderCompetitors();
                updateMarketChart();
            }
        }

        function renderEmployeesShort() {
            const list = document.getElementById('employeeListShort');
            if (game.employees.length === 0) {
                list.innerHTML = '<div class="empty">å¾“æ¥­å“¡ãŒã„ã¾ã›ã‚“</div>';
                return;
            }
            const recent = game.employees.slice(-3).reverse();
            list.innerHTML = recent.map(emp => `
                <div class="employee-card">
                    <div class="employee-name">ğŸ‘¤ ${emp.name}</div>
                    <div class="employee-stats">
                        <span>âš™ï¸ æŠ€è¡“: ${emp.abilities.technical}</span>
                        <span>ğŸ’¼ å–¶æ¥­: ${emp.abilities.sales}</span>
                        <span>ğŸ’° ${Math.floor(emp.salary / 10000)}ä¸‡å††</span>
                    </div>
                </div>
            `).join('');
        }

        function renderProductsShort() {
            const list = document.getElementById('productListShort');
            if (game.products.length === 0) {
                list.innerHTML = '<div class="empty">è£½å“ãŒã‚ã‚Šã¾ã›ã‚“<br>ğŸ’¡ æ–°è£½å“ã‚’é–‹ç™ºã—ã¾ã—ã‚‡ã†!</div>';
                return;
            }
            const recent = game.products.slice(-3).reverse();
            list.innerHTML = recent.map(product => `
                <div class="product-card">
                    <div class="product-name">ğŸ“¦ ${product.name}</div>
                    <div class="product-stats">
                        <span>â­ å“è³ª: ${product.quality}%</span>
                        <span>ğŸ’µ å£²ä¸Š: ${Math.floor(product.sales / 10000)}ä¸‡å††</span>
                    </div>
                </div>
            `).join('');
        }

        function renderCompetitors() {
            const list = document.getElementById('competitorList');
            list.innerHTML = competitors.map(comp => `
                <div class="competitor-card">
                    <div class="competitor-header">
                        <div class="competitor-name">ğŸ¢ ${comp.name}</div>
                        <div class="competitor-share">${comp.share.toFixed(1)}%</div>
                    </div>
                    <div class="competitor-info">
                        CEO: ${comp.ceo} | æˆ¦ç•¥: ${comp.strategy === 'aggressive' ? 'âš”ï¸ æ”»æ’ƒçš„' : comp.strategy === 'balanced' ? 'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹å‹' : 'ğŸ›¡ï¸ å®ˆå‚™çš„'}
                    </div>
                    <div class="competitor-info">
                        ğŸ‘¥ å¾“æ¥­å“¡: ${comp.employees}å | ğŸ’° å£²ä¸Š: ${Math.floor(comp.revenue / 100000000)}å„„å††
                    </div>
                </div>
            `).join('');
        }

        function updateDisplay() {
            document.getElementById('money').textContent = `${Math.floor(game.money / 10000)}ä¸‡`;
            document.getElementById('employeeCount').textContent = game.employees.length;
            document.getElementById('revenue').textContent = `${Math.floor(game.monthlyRevenue / 10000)}ä¸‡`;
            document.getElementById('brand').textContent = Math.max(0, Math.min(5, Math.floor(game.brandPower)));
            document.getElementById('gameDate').textContent = `${game.year}å¹´${game.month}æœˆ ç¬¬${game.week}é€±`;
            document.getElementById('marketShare').textContent = `${game.marketShare.toFixed(1)}%`;
            const brandCount = Math.max(0, Math.min(5, Math.floor(game.brandPower)));
            document.getElementById('brandPower').textContent = brandCount > 0 ? 'â­'.repeat(brandCount) : 'â€•';

            updateControls();
            updateCharts();
        }

        function updateControls() {
            const disabled = game.isBankrupt;
            document.querySelectorAll('[data-requires-active="true"]').forEach(btn => {
                btn.disabled = disabled;
            });
            const restartBtn = document.getElementById('restartButton');
            if (restartBtn) {
                restartBtn.style.display = disabled ? 'block' : 'none';
            }
        }

        function requireCompanyActive() {
            if (!game.isBankrupt) return true;
            showModal('æ“ä½œä¸å¯', 'å€’ç”£çŠ¶æ…‹ã®ãŸã‚æ“ä½œã§ãã¾ã›ã‚“ã€‚å†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
            return false;
        }

        function showHiring() {
            if (!requireCompanyActive()) return;
            if (game.money < 200000) {
                showModal('æ¡ç”¨å¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆæœ€ä½20ä¸‡å††å¿…è¦ï¼‰');
                return;
            }
            const names = ['ä½è—¤', 'éˆ´æœ¨', 'é«˜æ©‹', 'ç”°ä¸­', 'ä¼Šè—¤', 'æ¸¡è¾º'];
            const firstNames = ['å¤ªéƒ', 'èŠ±å­', 'ä¸€éƒ', 'ç¾å’²', 'å¥å¤ª', 'å„ªå­'];

            const candidate = {
                id: Date.now(),
                name: names[Math.floor(Math.random() * names.length)] + ' ' +
                      firstNames[Math.floor(Math.random() * firstNames.length)],
                abilities: {
                    technical: 30 + Math.floor(Math.random() * 50),
                    sales: 30 + Math.floor(Math.random() * 50)
                },
                motivation: 70,
                salary: 300000 + Math.floor(Math.random() * 200000)
            };

            const html = `
                <div style="margin: 12px 0;">ğŸ‘¤ å€™è£œè€…: <strong>${candidate.name}</strong></div>
                <div style="margin: 8px 0;">âš™ï¸ æŠ€è¡“åŠ›: <strong>${candidate.abilities.technical}</strong></div>
                <div style="margin: 8px 0;">ğŸ’¼ å–¶æ¥­åŠ›: <strong>${candidate.abilities.sales}</strong></div>
                <div style="margin: 12px 0; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    ğŸ’° å¸Œæœ›çµ¦ä¸: <strong style="color: #667eea;">${Math.floor(candidate.salary / 10000)}ä¸‡å††/æœˆ</strong>
                </div>
                <button class="btn" onclick="hireEmployee(${JSON.stringify(candidate).replace(/"/g, '&quot;')})">âœ… æ¡ç”¨ã™ã‚‹</button>
            `;
            showModal('ğŸ“‹ æ¡ç”¨é¢æ¥', html);
        }

        function hireEmployee(candidate) {
            if (!requireCompanyActive()) return;
            if (game.money < candidate.salary * 3) {
                showModal('æ¡ç”¨å¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ3ãƒ¶æœˆåˆ†ã®çµ¦ä¸ãŒå¿…è¦ï¼‰');
                return;
            }
            game.money -= candidate.salary * 3;
            game.employees.push(candidate);
            updateDisplay();
            renderActivePanel();
            closeModal();
            showModal('ğŸ‰ æ¡ç”¨æˆåŠŸ', `${candidate.name}ã•ã‚“ã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼`);
        }

        function developProduct() {
            if (!requireCompanyActive()) return;
            if (game.employees.length < 2) {
                showModal('é–‹ç™ºå¤±æ•—', 'æœ€ä½2åã®å¾“æ¥­å“¡ãŒå¿…è¦ã§ã™');
                return;
            }
            if (game.money < 2000000) {
                showModal('é–‹ç™ºå¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ200ä¸‡å††å¿…è¦ï¼‰');
                return;
            }
            game.money -= 2000000;
            const avgTech = game.employees.reduce((sum, emp) => sum + emp.abilities.technical, 0) / game.employees.length;
            const quality = Math.min(100, Math.floor(50 + (avgTech / 2) + Math.random() * 20));
            const product = {
                id: Date.now(),
                name: `è£½å“${game.products.length + 1}`,
                quality: quality,
                sales: 0
            };
            game.products.push(product);
            updateDisplay();
            renderActivePanel();
            showModal('ğŸ”§ é–‹ç™ºæˆåŠŸ', `${product.name}ã‚’é–‹ç™ºã—ã¾ã—ãŸï¼<br>å“è³ª: ${quality}%`);
        }

        function doMarketing() {
            if (!requireCompanyActive()) return;
            if (game.money < 1000000) {
                showModal('å®Ÿæ–½å¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ100ä¸‡å††å¿…è¦ï¼‰');
                return;
            }
            game.money -= 1000000;
            game.marketShare = Math.min(15, game.marketShare + 0.3);
            game.brandPower = Math.min(5, game.brandPower + 1);
            updateDisplay();
            renderActivePanel();
            updateRanking();
            showModal('ğŸ“¢ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆåŠŸ', 'å¸‚å ´ã‚·ã‚§ã‚¢ã¨ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›ãŒå‘ä¸Šï¼');
        }

        function getLoan() {
            if (!requireCompanyActive()) return;
            game.money += LOAN_AMOUNT;
            game.debt += LOAN_AMOUNT;
            updateDisplay();
            renderActivePanel();
            showModal('ğŸ¦ èè³‡å®Ÿè¡Œ', `500ä¸‡å††ã®èè³‡ã‚’å—ã‘ã¾ã—ãŸ<br>åˆ©ç‡: ${(LOAN_INTEREST_RATE * 100).toFixed(1)}%/æœˆ`);
        }

        function nextTurn() {
            if (!requireCompanyActive()) return;
            game.turn++;
            game.week++;
            if (game.week > 4) {
                game.week = 1;
                game.month++;
                if (game.month > 12) {
                    game.month = 1;
                    game.year++;
                }
                let revenue = 0;
                game.products.forEach(product => {
                    const productRevenue = product.quality * 10000;
                    product.sales += productRevenue;
                    revenue += productRevenue;
                });
                const salaryTotal = game.employees.reduce((sum, emp) => sum + emp.salary, 0);
                const interest = game.debt > 0 ? Math.floor(game.debt * LOAN_INTEREST_RATE) : 0;
                game.monthlyRevenue = revenue;
                game.revenueHistory.push(revenue);
                const profit = revenue - salaryTotal - interest;
                game.money += profit;
                if (game.money < 0) {
                    game.isBankrupt = true;
                    updateDisplay();
                    renderActivePanel();
                    updateRanking();
                    showModal('ğŸ’” ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼', 'è³‡é‡‘ä¸è¶³ã§å€’ç”£ã—ã¾ã—ãŸ...<br>å†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const summaryLines = [
                    `ğŸ“Š å£²ä¸Š: ${Math.floor(revenue / 10000)}ä¸‡å††`,
                    `ğŸ‘¥ äººä»¶è²»: ${Math.floor(salaryTotal / 10000)}ä¸‡å††`
                ];
                if (interest > 0) {
                    summaryLines.push(`ğŸ“ˆ åˆ©æ¯: ${Math.floor(interest / 10000)}ä¸‡å††`);
                }
                const profitColor = profit >= 0 ? '#4caf50' : '#f44336';
                summaryLines.push(`<div style="margin-top: 8px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    ğŸ’° æœ€çµ‚åˆ©ç›Š: <strong style="color: ${profitColor}">${Math.floor(profit / 10000)}ä¸‡å††</strong>
                </div>`);
                showModal('ğŸ“… æœˆæ¬¡æ±ºç®—', summaryLines.join('<br>'));
                updateCompetitors();
                generateNews();
            }
            updateDisplay();
            renderActivePanel();
            updateRanking();
        }

        function saveGame() {
            if (!requireCompanyActive()) return;
            try {
                const saveData = Object.assign({}, game, { activePanel });
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
                showModal('ğŸ’¾ ä¿å­˜å®Œäº†', 'ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Failed to save game', error);
                showModal('ä¿å­˜å¤±æ•—', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function restartGame() {
            closeModal();
            resetGameState();
            addInitialEmployee();
            generateInitialNews();
            updateDisplay();
            updateRanking();
            initCharts();
            showPanel('management');
            localStorage.removeItem(SAVE_KEY);
            showModal('ğŸ”„ å†ã‚¹ã‚¿ãƒ¼ãƒˆ', 'æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body.replace(/\n/g, '<br>');
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        init();
    </script>
</body>
</html>
