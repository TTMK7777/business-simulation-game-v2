// Chart.jsçµ±åˆ
import { Chart } from './charts'

// LocalForageã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆï¼ˆTauriå¯¾å¿œï¼‰
import { storageHelpers, loadSlotData, saveSlotData, deleteSlotData, type SaveMetadata } from './storage'
import type Phaser from 'phaser'
import { initCharacterRenderer, getCharacterScene, type AnimationState, type CharacterScene } from './animation/CharacterRenderer'

        // Phase 1: 15ç¨®é¡ã®åŸºæœ¬æ€§æ ¼å®šç¾©
        const PERSONALITIES = {
            passionate: {
                name: 'æƒ…ç†±å®¶',
                emoji: 'ğŸ”¥',
                effects: { developmentSpeed: 1.2 },
                compatible: ['optimist', 'charismatic'],
                incompatible: ['cautious']
            },
            logical: {
                name: 'è«–ç†æ€è€ƒå‹',
                emoji: 'ğŸ§ ',
                effects: { bugRate: 0.7 },
                compatible: ['perfectionist', 'researcher'],
                incompatible: ['intuitive']
            },
            cooperative: {
                name: 'å”èª¿æ€§é‡è¦–',
                emoji: 'ğŸ¤',
                effects: { teamEfficiency: 1.15 },
                compatible: ['passionate', 'optimist'],
                incompatible: ['lone_genius']
            },
            ambitious: {
                name: 'é‡å¿ƒå®¶',
                emoji: 'ğŸ’¼',
                effects: { promotionDesire: 1.3 },
                compatible: ['strategist'],
                incompatible: ['cooperative']
            },
            charismatic: {
                name: 'ã‚«ãƒªã‚¹ãƒ',
                emoji: 'ğŸŒŸ',
                effects: { salesPower: 1.25 },
                compatible: ['passionate', 'optimist'],
                incompatible: ['introverted']
            },
            perfectionist: {
                name: 'å®Œç’§ä¸»ç¾©è€…',
                emoji: 'ğŸ¯',
                effects: { quality: 1.2, speed: 0.9 },
                compatible: ['logical', 'researcher'],
                incompatible: ['optimist']
            },
            action_oriented: {
                name: 'è¡Œå‹•æ´¾',
                emoji: 'ğŸš€',
                effects: { decisionSpeed: 1.2 },
                compatible: ['intuitive'],
                incompatible: ['cautious']
            },
            researcher: {
                name: 'ç ”ç©¶è€…æ°—è³ª',
                emoji: 'ğŸ“š',
                effects: { learningSpeed: 1.3 },
                compatible: ['logical', 'introverted'],
                incompatible: ['action_oriented']
            },
            optimist: {
                name: 'æ¥½è¦³ä¸»ç¾©è€…',
                emoji: 'ğŸ˜Š',
                effects: { stressResistance: 1.2 },
                compatible: ['passionate', 'charismatic'],
                incompatible: ['perfectionist']
            },
            cautious: {
                name: 'æ…é‡æ´¾',
                emoji: 'ğŸ”’',
                effects: { riskManagement: 1.25 },
                compatible: ['strategist', 'perfectionist'],
                incompatible: ['action_oriented', 'passionate']
            },
            creative: {
                name: 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼',
                emoji: 'ğŸ¨',
                effects: { creativity: 1.3 },
                compatible: ['intuitive'],
                incompatible: ['logical']
            },
            intuitive: {
                name: 'ç›´æ„Ÿå‹',
                emoji: 'âš¡',
                effects: { inspirationRate: 1.2 },
                compatible: ['creative', 'action_oriented'],
                incompatible: ['logical', 'cautious']
            },
            introverted: {
                name: 'å†…å‘çš„',
                emoji: 'ğŸ§˜',
                effects: { soloWork: 1.25 },
                compatible: ['researcher'],
                incompatible: ['charismatic', 'cooperative']
            },
            lone_genius: {
                name: 'å­¤é«˜ã®å¤©æ‰',
                emoji: 'ğŸ”ï¸',
                effects: { ability: 1.4, cooperation: 0.5 },
                compatible: [],
                incompatible: ['cooperative', 'charismatic']
            },
            strategist: {
                name: 'æˆ¦ç•¥å®¶',
                emoji: 'ğŸ—ºï¸',
                effects: { projectSuccess: 1.15 },
                compatible: ['cautious', 'ambitious'],
                incompatible: ['intuitive']
            }
        };

        // Phase 2: ã‚µãƒ–ç‰¹æ€§20ç¨®é¡å®šç¾©
        const SUB_TRAITS = {
            // é–‹ç™ºç³»
            code_reviewer: { name: 'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼', emoji: 'ğŸ”', effect: 'ãƒã‚°ç™ºè¦‹ç‡+40%' },
            debugger: { name: 'ãƒ‡ãƒãƒƒã‚¬ãƒ¼', emoji: 'ğŸ›', effect: 'ãƒã‚°ä¿®æ­£é€Ÿåº¦+50%' },
            architect: { name: 'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ', emoji: 'ğŸ—ï¸', effect: 'å¤§è¦æ¨¡é–‹ç™ºã§èƒ½åŠ›1.5å€' },
            rapid_dev: { name: 'é€Ÿæ”»é–‹ç™º', emoji: 'âš¡', effect: 'å°è¦æ¨¡é–‹ç™ºã‚’1ã‚¿ãƒ¼ãƒ³ã§å®Œäº†' },

            // ã‚¢ã‚¤ãƒ‡ã‚¢ç³»
            inspiration: { name: 'ã²ã‚‰ã‚ã', emoji: 'ğŸ’¡', effect: 'æœˆ1å›ã€ç”»æœŸçš„æ©Ÿèƒ½ã‚’æ€ã„ã¤ã' },
            trend_catcher: { name: 'ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', emoji: 'ğŸ“¡', effect: 'å¸‚å ´ãƒ‹ãƒ¼ã‚ºäºˆæ¸¬+30%' },
            tech_foresight: { name: 'æŠ€è¡“å…ˆèª­ã¿', emoji: 'ğŸ”®', effect: 'æ–°æŠ€è¡“ç™»å ´ã‚’2ã‚¿ãƒ¼ãƒ³å‰ã«å¯ŸçŸ¥' },

            // å¯¾äººç³»
            mentor: { name: 'ãƒ¡ãƒ³ã‚¿ãƒ¼', emoji: 'ğŸ‘¨â€ğŸ«', effect: 'æ–°äººè‚²æˆé€Ÿåº¦+50%' },
            mediator: { name: 'èª¿åœè€…', emoji: 'âš–ï¸', effect: 'ãƒãƒ¼ãƒ å¯¾ç«‹ã‚’è§£æ¶ˆ' },
            networker: { name: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚«ãƒ¼', emoji: 'ğŸŒ', effect: 'å¤–éƒ¨äººè„ˆã§æƒ…å ±å…¥æ‰‹' },

            // ç²¾ç¥ç³»
            steel_mind: { name: 'é‹¼ã®ãƒ¡ãƒ³ã‚¿ãƒ«', emoji: 'ğŸ›¡ï¸', effect: 'ãƒ‡ã‚¹ãƒãƒ¼ãƒã§ã‚‚èƒ½åŠ›ä½ä¸‹ãªã—' },
            crunch_resistant: { name: 'ã‚¯ãƒ©ãƒ³ãƒè€æ€§', emoji: 'ğŸ’ª', effect: 'æ®‹æ¥­ç¶šãã§ã‚‚å¥åº·ç¶­æŒ' },
            pressure_converter: { name: 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼å¤‰æ›', emoji: 'âš¡', effect: 'ç· åˆ‡ç›´å‰ã«èƒ½åŠ›+30%' },

            // ãƒã‚¬ãƒ†ã‚£ãƒ–ç‰¹æ€§
            easily_bored: { name: 'é£½ãæ€§', emoji: 'ğŸ˜‘', effect: '3ãƒ¶æœˆã§èƒ½åŠ›-20%', negative: true },
            morning_weak: { name: 'æœãŒè‹¦æ‰‹', emoji: 'ğŸ˜´', effect: 'åˆå‰ä¸­ã®ä½œæ¥­åŠ¹ç‡-30%', negative: true },
            over_perfectionist: { name: 'å®Œç’§ä¸»ç¾©ã™ãã‚‹', emoji: 'â°', effect: 'ç´æœŸé…å»¶ãƒªã‚¹ã‚¯+20%', negative: true },

            // ãã®ä»–
            fast_learner: { name: 'æ—©ç¿’å¾—', emoji: 'ğŸ“–', effect: 'ç ”ä¿®åŠ¹æœ+50%' },
            cost_conscious: { name: 'ã‚³ã‚¹ãƒˆæ„è­˜', emoji: 'ğŸ’°', effect: 'ç„¡é§„ãªæ”¯å‡ºã‚’15%å‰Šæ¸›' },
            health_conscious: { name: 'å¥åº·å¿—å‘', emoji: 'ğŸ¥—', effect: 'ç—…æ¬ ãƒªã‚¹ã‚¯-50%' },
            night_owl: { name: 'å¤œå‹äººé–“', emoji: 'ğŸ¦‰', effect: 'æ·±å¤œä½œæ¥­ã§èƒ½åŠ›+20%' }
        };

        // Phase 2.5: æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å®šç¾©ï¼ˆ8é …ç›®ï¼‰
        // è·èƒ½ï¼ˆæŠ€è¡“åŠ›ãƒ»å–¶æ¥­åŠ›ãªã©ï¼‰ã¨ã¯åˆ¥ã®æ€§æ ¼ç‰¹æ€§
        const TEMPERAMENT_TRAITS = {
            boldness: {
                name: 'å¤§èƒ†ã•',
                emoji: 'ğŸ²',
                description: 'æ–°ã—ã„æŒ‘æˆ¦ã‚„ãƒªã‚¹ã‚¯ã‚’æã‚Œãªã„åº¦åˆã„',
                effects: 'æ–°è£½å“é–‹ç™ºæ™‚ã®ãƒœãƒ¼ãƒŠã‚¹ã€å¤±æ•—æ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›'
            },
            bravery: {
                name: 'å‹‡æ•¢ã•',
                emoji: 'âš”ï¸',
                description: 'å›°é›£ã‚„å±æ©Ÿã«ç«‹ã¡å‘ã‹ã†åŠ›',
                effects: 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ä¸‹ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã€ç´æœŸé–“è¿‘ã®åŠ¹ç‡UP'
            },
            cooperation: {
                name: 'å”èª¿æ€§',
                emoji: 'ğŸ¤',
                description: 'ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„ä»–è€…ã¨ã®å”åŠ›ã‚’é‡è¦–',
                effects: 'ãƒãƒ¼ãƒ ãƒœãƒ¼ãƒŠã‚¹å¢—åŠ ã€éƒ¨ç½²åŠ¹ç‡UPã€ç›¸æ€§åˆ¤å®šã«å½±éŸ¿'
            },
            creativity: {
                name: 'å‰µé€ æ€§',
                emoji: 'ğŸ’¡',
                description: 'æ–¬æ–°ãªç™ºæƒ³ã‚„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã™åŠ›',
                effects: 'ä¼ç”»è·ãƒ»é–‹ç™ºè·ã§ã®åŠ¹ç‡ãƒœãƒ¼ãƒŠã‚¹ã€ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºç‡UP'
            },
            conscientiousness: {
                name: 'èª å®Ÿæ€§',
                emoji: 'ğŸ“',
                description: 'è²¬ä»»æ„Ÿãƒ»çœŸé¢ç›®ã•ãƒ»ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›ã™ã‚‹å‚¾å‘',
                effects: 'å“è³ªå‘ä¸Šã€ãƒã‚°ç‡ä½æ¸›ã€é•·æœŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®ãƒœãƒ¼ãƒŠã‚¹'
            },
            emotionalStability: {
                name: 'æ„Ÿæƒ…å®‰å®šæ€§',
                emoji: 'ğŸ§˜',
                description: 'ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ã€æƒ…ç·’ã®å®‰å®š',
                effects: 'æ®‹æ¥­æ™‚ã®åŠ¹ç‡ä½ä¸‹ã‚’è»½æ¸›ã€é•·æœŸå‹¤å‹™ã§ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ'
            },
            sociability: {
                name: 'ç¤¾äº¤æ€§',
                emoji: 'ğŸ—£ï¸',
                description: 'ä»–è€…ã¨ã®äº¤æµã‚„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›',
                effects: 'å–¶æ¥­è·ã§ã®åŠ¹ç‡ãƒœãƒ¼ãƒŠã‚¹ã€é¡§å®¢æº€è¶³åº¦UPã€æ¡ç”¨æ´»å‹•è£œåŠ©'
            },
            cautiousness: {
                name: 'æ…é‡ã•',
                emoji: 'ğŸ”',
                description: 'ãƒªã‚¹ã‚¯å›é¿ã€è¨ˆç”»çš„ãªè¡Œå‹•',
                effects: 'ãƒã‚°ç‡ä½æ¸›ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤±æ•—ç‡æ¸›å°‘ã€ç®¡ç†è·å‘ã'
            }
        };

        // æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆé–¢æ•°
        function generateTemperament(personalityKey = null) {
            // åŸºæœ¬å€¤ï¼ˆ0-100ã§ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const base = {
                boldness: 30 + Math.floor(Math.random() * 50),
                bravery: 30 + Math.floor(Math.random() * 50),
                cooperation: 30 + Math.floor(Math.random() * 50),
                creativity: 30 + Math.floor(Math.random() * 50),
                conscientiousness: 30 + Math.floor(Math.random() * 50),
                emotionalStability: 30 + Math.floor(Math.random() * 50),
                sociability: 30 + Math.floor(Math.random() * 50),
                cautiousness: 30 + Math.floor(Math.random() * 50)
            };

            // æ€§æ ¼ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹è£œæ­£
            if (personalityKey && PERSONALITIES[personalityKey]) {
                const adjustments = {
                    passionate: { boldness: 20, cautiousness: -15, emotionalStability: -10 },
                    logical: { creativity: -10, conscientiousness: 15, cautiousness: 20 },
                    cooperative: { cooperation: 25, sociability: 15 },
                    ambitious: { boldness: 25, cooperation: -15 },
                    charismatic: { sociability: 25, bravery: 15 },
                    perfectionist: { conscientiousness: 25, cautiousness: 20, boldness: -10 },
                    action_oriented: { boldness: 20, cautiousness: -20, bravery: 15 },
                    researcher: { creativity: 15, sociability: -15, cautiousness: 10 },
                    optimist: { emotionalStability: 20, bravery: 10 },
                    cautious: { cautiousness: 25, boldness: -20 },
                    creative: { creativity: 30, conscientiousness: -10 },
                    intuitive: { creativity: 20, cautiousness: -15 },
                    introverted: { sociability: -25, emotionalStability: 10 },
                    lone_genius: { sociability: -30, cooperation: -20, creativity: 25 },
                    strategist: { cautiousness: 20, conscientiousness: 15 }
                };

                const adjustment = adjustments[personalityKey];
                if (adjustment) {
                    Object.keys(adjustment).forEach(key => {
                        base[key] = Math.max(0, Math.min(100, base[key] + adjustment[key]));
                    });
                }
            }

            return base;
        }

        // Phase 2: éš ã‚Œç‰¹æ€§5ç¨®é¡å®šç¾©
        const HIDDEN_TRAITS = {
            latent_leader: {
                name: 'æ½œåœ¨ãƒªãƒ¼ãƒ€ãƒ¼',
                emoji: 'ğŸ”¥',
                effect: '6ãƒ¶æœˆå¾Œã€çªç„¶ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆèƒ½åŠ›é–‹èŠ±',
                revealTurn: 24  // 6ãƒ¶æœˆ = 24é€±
            },
            late_bloomer: {
                name: 'å¤§å™¨æ™©æˆ',
                emoji: 'ğŸ’',
                effect: '1å¹´å¾Œã«èƒ½åŠ›+50%',
                revealTurn: 48
            },
            burnout_prone: {
                name: 'ç‡ƒãˆå°½ãç—‡å€™ç¾¤',
                emoji: 'ğŸ”¥â¡ï¸ğŸ’¨',
                effect: 'æˆåŠŸå¾Œã«çªç„¶é€€è·ãƒªã‚¹ã‚¯',
                revealTurn: 36,
                negative: true
            },
            self_taught: {
                name: 'ç‹¬å­¦ã®å¤©æ‰',
                emoji: 'ğŸ“',
                effect: 'ç ”ä¿®ãªã—ã§å‹æ‰‹ã«ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—',
                revealTurn: 12
            },
            inconsistent: {
                name: 'ãƒ ãƒ©ãŒã‚ã‚‹',
                emoji: 'ğŸŒŠ',
                effect: 'æœˆã”ã¨ã«èƒ½åŠ›ãŒ20-120%ã§å¤‰å‹•',
                revealTurn: 8,
                negative: true
            }
        };

        // ğŸ¢ éƒ¨ç½²ã‚·ã‚¹ãƒ†ãƒ å®šç¾©
        const DEPARTMENTS = {
            development: {
                name: 'é–‹ç™ºéƒ¨',
                emoji: 'ğŸ’»',
                primaryAbility: 'technical',
                salaryMultiplier: 1.0,
                description: 'è£½å“ã®é–‹ç™ºã‚’æ‹…å½“',
                // éƒ¨ç½²åˆ¥æ¡ç”¨ã‚·ã‚¹ãƒ†ãƒ : ã‚¹ã‚­ãƒ«é‡ã¿ä»˜ã‘
                abilityWeights: {
                    technical: { min: 60, max: 95 },  // æŠ€è¡“åŠ›é«˜ã‚
                    sales: { min: 20, max: 60 },      // å–¶æ¥­åŠ›ä½ã‚
                    planning: { min: 40, max: 80 },   // ä¼ç”»åŠ›ä¸­ç¨‹åº¦
                    management: { min: 30, max: 70 }  // ç®¡ç†åŠ›ä¸­ç¨‹åº¦
                },
                // æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é‡ã¿ä»˜ã‘
                temperamentWeights: {
                    creativity: 20,        // å‰µé€ æ€§ãƒœãƒ¼ãƒŠã‚¹
                    conscientiousness: 15, // èª å®Ÿæ€§ãƒœãƒ¼ãƒŠã‚¹
                    sociability: -15,      // ç¤¾äº¤æ€§ãƒšãƒŠãƒ«ãƒ†ã‚£
                    cautiousness: 10       // æ…é‡ã•ãƒœãƒ¼ãƒŠã‚¹
                }
            },
            sales: {
                name: 'å–¶æ¥­éƒ¨',
                emoji: 'ğŸ“ˆ',
                primaryAbility: 'sales',
                salaryMultiplier: 1.1,
                description: 'è£½å“ã®è²©å£²ã‚’æ‹…å½“',
                abilityWeights: {
                    technical: { min: 20, max: 60 },
                    sales: { min: 60, max: 95 },      // å–¶æ¥­åŠ›é«˜ã‚
                    planning: { min: 30, max: 70 },
                    management: { min: 40, max: 75 }
                },
                temperamentWeights: {
                    sociability: 25,       // ç¤¾äº¤æ€§ãƒœãƒ¼ãƒŠã‚¹
                    boldness: 15,          // å¤§èƒ†ã•ãƒœãƒ¼ãƒŠã‚¹
                    bravery: 10,           // å‹‡æ•¢ã•ãƒœãƒ¼ãƒŠã‚¹
                    cautiousness: -15      // æ…é‡ã•ãƒšãƒŠãƒ«ãƒ†ã‚£
                }
            },
            planning: {
                name: 'ä¼ç”»éƒ¨',
                emoji: 'ğŸ’¡',
                primaryAbility: 'planning',
                salaryMultiplier: 0.95,
                description: 'æ–°è£½å“ã®ä¼ç”»ã‚’æ‹…å½“',
                abilityWeights: {
                    technical: { min: 40, max: 75 },
                    sales: { min: 35, max: 75 },
                    planning: { min: 60, max: 95 },   // ä¼ç”»åŠ›é«˜ã‚
                    management: { min: 40, max: 75 }
                },
                temperamentWeights: {
                    creativity: 30,        // å‰µé€ æ€§ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæœ€é«˜ï¼‰
                    cooperation: 15,       // å”èª¿æ€§ãƒœãƒ¼ãƒŠã‚¹
                    boldness: 10           // å¤§èƒ†ã•ãƒœãƒ¼ãƒŠã‚¹
                }
            },
            management: {
                name: 'ç®¡ç†éƒ¨',
                emoji: 'ğŸ“Š',
                primaryAbility: 'management',
                salaryMultiplier: 1.05,
                description: 'ä¼šç¤¾å…¨ä½“ã®ç®¡ç†ã‚’æ‹…å½“',
                abilityWeights: {
                    technical: { min: 30, max: 70 },
                    sales: { min: 30, max: 70 },
                    planning: { min: 40, max: 75 },
                    management: { min: 60, max: 95 }  // ç®¡ç†åŠ›é«˜ã‚
                },
                temperamentWeights: {
                    conscientiousness: 25,  // èª å®Ÿæ€§ãƒœãƒ¼ãƒŠã‚¹
                    cautiousness: 20,       // æ…é‡ã•ãƒœãƒ¼ãƒŠã‚¹
                    emotionalStability: 15, // æ„Ÿæƒ…å®‰å®šæ€§ãƒœãƒ¼ãƒŠã‚¹
                    cooperation: 10         // å”èª¿æ€§ãƒœãƒ¼ãƒŠã‚¹
                }
            }
        };

        // ğŸ‘” å½¹è·ã‚·ã‚¹ãƒ†ãƒ å®šç¾© (æ˜‡é€²ã‚·ã‚¹ãƒ†ãƒ )
        const POSITIONS = {
            staff: {
                name: 'ã‚¹ã‚¿ãƒƒãƒ•',
                emoji: 'ğŸ‘¤',
                salaryMultiplier: 1.0,
                requiredAbility: 0,
                managementBonus: 0,
                description: 'ä¸€èˆ¬ç¤¾å“¡'
            },
            senior: {
                name: 'ã‚·ãƒ‹ã‚¢',
                emoji: 'â­',
                salaryMultiplier: 1.3,
                requiredAbility: 70,
                managementBonus: 0.1,
                description: 'ä¸Šç´šç¤¾å“¡'
            },
            manager: {
                name: 'èª²é•·',
                emoji: 'ğŸ‘”',
                salaryMultiplier: 1.6,
                requiredAbility: 80,
                managementBonus: 0.2,
                canManage: 5,
                description: 'èª²é•·è· (5åã¾ã§ç®¡ç†å¯èƒ½)'
            },
            director: {
                name: 'éƒ¨é•·',
                emoji: 'ğŸ’¼',
                salaryMultiplier: 2.0,
                requiredAbility: 90,
                managementBonus: 0.3,
                canManage: 15,
                description: 'éƒ¨é•·è· (15åã¾ã§ç®¡ç†å¯èƒ½)'
            }
        };

        // ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ å®šç¾©
        const SKILL_TREE = {
            technical: {
                name: 'æŠ€è¡“ã‚¹ã‚­ãƒ«',
                emoji: 'ğŸ’»',
                color: '#667eea',
                skills: {
                    tech_basic: {
                        name: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åŸºç¤',
                        description: 'åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—',
                        cost: 1,
                        effect: { technical: 5 },
                        prerequisites: [],
                        tier: 1,
                        icon: 'ğŸ“'
                    },
                    tech_advanced: {
                        name: 'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ',
                        description: 'ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è¨­è¨ˆèƒ½åŠ›ã‚’ç²å¾—',
                        cost: 2,
                        effect: { technical: 10, planning: 3 },
                        prerequisites: ['tech_basic'],
                        tier: 2,
                        icon: 'ğŸ—ï¸'
                    },
                    tech_optimization: {
                        name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–',
                        description: 'ã‚³ãƒ¼ãƒ‰ã‚’é«˜é€ŸåŒ–ã—å“è³ªã‚’å‘ä¸Š',
                        cost: 2,
                        effect: { technical: 8 },
                        prerequisites: ['tech_advanced'],
                        tier: 3,
                        icon: 'âš¡',
                        special: 'product_quality_bonus'
                    },
                    tech_ai: {
                        name: 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’',
                        description: 'æœ€æ–°ã®AIæŠ€è¡“ã‚’æ´»ç”¨ã§ãã‚‹',
                        cost: 3,
                        effect: { technical: 15, planning: 5 },
                        prerequisites: ['tech_advanced'],
                        tier: 3,
                        icon: 'ğŸ¤–'
                    },
                    tech_security: {
                        name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ',
                        description: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å°‚é–€çŸ¥è­˜ã‚’ç²å¾—',
                        cost: 2,
                        effect: { technical: 10, management: 3 },
                        prerequisites: ['tech_basic'],
                        tier: 2,
                        icon: 'ğŸ”’'
                    }
                }
            },
            sales: {
                name: 'å–¶æ¥­ã‚¹ã‚­ãƒ«',
                emoji: 'ğŸ“ˆ',
                color: '#f093fb',
                skills: {
                    sales_basic: {
                        name: 'é¡§å®¢å¯¾å¿œåŸºç¤',
                        description: 'åŸºæœ¬çš„ãªå–¶æ¥­ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—',
                        cost: 1,
                        effect: { sales: 5 },
                        prerequisites: [],
                        tier: 1,
                        icon: 'ğŸ¤'
                    },
                    sales_negotiation: {
                        name: 'äº¤æ¸‰è¡“',
                        description: 'é«˜åº¦ãªäº¤æ¸‰ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ç²å¾—',
                        cost: 2,
                        effect: { sales: 10, management: 3 },
                        prerequisites: ['sales_basic'],
                        tier: 2,
                        icon: 'ğŸ’¼'
                    },
                    sales_presentation: {
                        name: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
                        description: 'èª¬å¾—åŠ›ã®ã‚ã‚‹ææ¡ˆãŒã§ãã‚‹',
                        cost: 2,
                        effect: { sales: 8, planning: 4 },
                        prerequisites: ['sales_basic'],
                        tier: 2,
                        icon: 'ğŸ“Š'
                    },
                    sales_closing: {
                        name: 'ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°æŠ€è¡“',
                        description: 'ç¢ºå®Ÿã«å¥‘ç´„ã‚’ç²å¾—ã§ãã‚‹',
                        cost: 3,
                        effect: { sales: 15 },
                        prerequisites: ['sales_negotiation', 'sales_presentation'],
                        tier: 3,
                        icon: 'ğŸ¯',
                        special: 'revenue_bonus'
                    },
                    sales_account: {
                        name: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†',
                        description: 'é•·æœŸçš„ãªé¡§å®¢é–¢ä¿‚ã‚’æ§‹ç¯‰',
                        cost: 2,
                        effect: { sales: 10, management: 5 },
                        prerequisites: ['sales_negotiation'],
                        tier: 3,
                        icon: 'ğŸ“‡'
                    }
                }
            },
            planning: {
                name: 'ä¼ç”»ã‚¹ã‚­ãƒ«',
                emoji: 'ğŸ’¡',
                color: '#4facfe',
                skills: {
                    plan_basic: {
                        name: 'ä¼ç”»ç«‹æ¡ˆåŸºç¤',
                        description: 'åŸºæœ¬çš„ãªä¼ç”»åŠ›ã‚’ç¿’å¾—',
                        cost: 1,
                        effect: { planning: 5 },
                        prerequisites: [],
                        tier: 1,
                        icon: 'âœï¸'
                    },
                    plan_market: {
                        name: 'å¸‚å ´åˆ†æ',
                        description: 'å¸‚å ´å‹•å‘ã‚’èª­ã¿å–ã‚‹åŠ›ã‚’ç²å¾—',
                        cost: 2,
                        effect: { planning: 10, sales: 3 },
                        prerequisites: ['plan_basic'],
                        tier: 2,
                        icon: 'ğŸ”'
                    },
                    plan_innovation: {
                        name: 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€è€ƒ',
                        description: 'é©æ–°çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã›ã‚‹',
                        cost: 3,
                        effect: { planning: 15, technical: 5 },
                        prerequisites: ['plan_market'],
                        tier: 3,
                        icon: 'ğŸ’«',
                        special: 'product_innovation_bonus'
                    },
                    plan_strategy: {
                        name: 'æˆ¦ç•¥ç«‹æ¡ˆ',
                        description: 'é•·æœŸçš„ãªæˆ¦ç•¥ã‚’ç­–å®šã§ãã‚‹',
                        cost: 2,
                        effect: { planning: 10, management: 5 },
                        prerequisites: ['plan_basic'],
                        tier: 2,
                        icon: 'ğŸ²'
                    },
                    plan_ux: {
                        name: 'UXè¨­è¨ˆ',
                        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æœ€é©åŒ–ã§ãã‚‹',
                        cost: 2,
                        effect: { planning: 8, technical: 4 },
                        prerequisites: ['plan_basic'],
                        tier: 2,
                        icon: 'ğŸ¨'
                    }
                }
            },
            management: {
                name: 'ç®¡ç†ã‚¹ã‚­ãƒ«',
                emoji: 'ğŸ“Š',
                color: '#f857a6',
                skills: {
                    mgmt_basic: {
                        name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†åŸºç¤',
                        description: 'åŸºæœ¬çš„ãªç®¡ç†ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—',
                        cost: 1,
                        effect: { management: 5 },
                        prerequisites: [],
                        tier: 1,
                        icon: 'ğŸ“‹'
                    },
                    mgmt_team: {
                        name: 'ãƒãƒ¼ãƒ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ',
                        description: 'ãƒãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ç®¡ç†ã§ãã‚‹',
                        cost: 2,
                        effect: { management: 10, sales: 3 },
                        prerequisites: ['mgmt_basic'],
                        tier: 2,
                        icon: 'ğŸ‘¥',
                        special: 'team_productivity_bonus'
                    },
                    mgmt_finance: {
                        name: 'è²¡å‹™ç®¡ç†',
                        description: 'äºˆç®—ç®¡ç†ã¨è²¡å‹™åˆ†æãŒã§ãã‚‹',
                        cost: 2,
                        effect: { management: 10 },
                        prerequisites: ['mgmt_basic'],
                        tier: 2,
                        icon: 'ğŸ’°',
                        special: 'cost_reduction'
                    },
                    mgmt_leadership: {
                        name: 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—',
                        description: 'çµ„ç¹”å…¨ä½“ã‚’ç‰½å¼•ã§ãã‚‹',
                        cost: 3,
                        effect: { management: 15, sales: 5 },
                        prerequisites: ['mgmt_team'],
                        tier: 3,
                        icon: 'ğŸ‘‘',
                        special: 'company_bonus'
                    },
                    mgmt_risk: {
                        name: 'ãƒªã‚¹ã‚¯ç®¡ç†',
                        description: 'ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã—å¯¾å‡¦ã§ãã‚‹',
                        cost: 2,
                        effect: { management: 8, planning: 4 },
                        prerequisites: ['mgmt_basic'],
                        tier: 2,
                        icon: 'ğŸ›¡ï¸'
                    }
                }
            }
        };

        // ã‚¹ã‚­ãƒ«ã®ç‰¹æ®ŠåŠ¹æœå®šç¾©
        const SKILL_EFFECTS = {
            product_quality_bonus: { description: 'è£½å“å“è³ª+10%', value: 0.1 },
            revenue_bonus: { description: 'å£²ä¸Š+5%', value: 0.05 },
            product_innovation_bonus: { description: 'æ–°è£½å“é–‹ç™ºæ™‚é–“-20%', value: 0.2 },
            team_productivity_bonus: { description: 'ãƒãƒ¼ãƒ ç”Ÿç”£æ€§+15%', value: 0.15 },
            cost_reduction: { description: 'é‹å–¶ã‚³ã‚¹ãƒˆ-10%', value: 0.1 },
            company_bonus: { description: 'å…¨å¾“æ¥­å“¡ã®èƒ½åŠ›+3', value: 3 }
        };

        // ã‚ªãƒ•ã‚£ã‚¹ãƒ¬ãƒ™ãƒ«å®šç¾©ï¼ˆ5æ®µéšã®æˆé•·ã‚·ã‚¹ãƒ†ãƒ ï¼‰
        const OFFICE_LEVELS = {
            1: {
                name: 'ã‚¢ãƒ‘ãƒ¼ãƒˆã‚ªãƒ•ã‚£ã‚¹',
                emoji: 'ğŸ ',
                maxEmployees: 6,
                description: 'å°ã•ãªã‚¢ãƒ‘ãƒ¼ãƒˆã®ä¸€å®¤ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ',
                unlockConditions: { employees: 1, money: 0, marketShare: 0 }
            },
            2: {
                name: 'ã‚·ã‚§ã‚¢ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ãƒšãƒ¼ã‚¹',
                emoji: 'â˜•',
                maxEmployees: 12,
                description: 'å…±ç”¨ã‚ªãƒ•ã‚£ã‚¹ã§æˆé•·ã®å…†ã—',
                unlockConditions: { employees: 6, money: 1500000, marketShare: 3 }
            },
            3: {
                name: 'å°è¦æ¨¡ã‚ªãƒ•ã‚£ã‚¹',
                emoji: 'ğŸ¢',
                maxEmployees: 24,
                description: 'ç‹¬ç«‹ã—ãŸå°ã•ãªã‚ªãƒ•ã‚£ã‚¹',
                unlockConditions: { employees: 12, money: 4000000, marketShare: 6 }
            },
            4: {
                name: 'å¤§è¦æ¨¡ã‚ªãƒ•ã‚£ã‚¹',
                emoji: 'ğŸ›ï¸',
                maxEmployees: 40,
                description: 'ãƒ•ãƒ­ã‚¢å…¨ä½“ã‚’å ã‚ã‚‹ç«‹æ´¾ãªã‚ªãƒ•ã‚£ã‚¹',
                unlockConditions: { employees: 24, money: 9000000, marketShare: 12 }
            },
            5: {
                name: 'è‡ªç¤¾ãƒ“ãƒ«',
                emoji: 'ğŸ°',
                maxEmployees: 70,
                description: 'å¿µé¡˜ã®è‡ªç¤¾ãƒ“ãƒ«ï¼æ¥­ç•Œã®ãƒªãƒ¼ãƒ€ãƒ¼ã¸',
                unlockConditions: { employees: 40, money: 18000000, marketShare: 22 }
            }
        };

        const defaultGameState = {
            money: 10000000,
            employees: [],
            products: [],
            turn: 1,
            year: 2025,
            month: 1,
            week: 1,
            marketShare: 0.1,
            brandPower: 1,
            monthlyRevenue: 0,
            debt: 0,
            isBankrupt: false,
            revenueHistory: [],
            officeLevel: 1  // åˆæœŸãƒ¬ãƒ™ãƒ«: ã‚¢ãƒ‘ãƒ¼ãƒˆã‚ªãƒ•ã‚£ã‚¹
        };

        const LOAN_AMOUNT = 5000000;
        const LOAN_INTEREST_RATE = 0.02;
        const SAVE_KEY = 'businessEmpire';

        const game = cloneDefaults();
        let phaserGame: Phaser.Game | null = null;
        let characterScene: CharacterScene | null = null;
        let activePanel = 'overview';
        let revenueChart = null;
        let marketChart = null;
        let currentSlotId = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ­ãƒƒãƒˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠã•ã‚Œã‚‹ï¼‰

        const competitors = [
            { name: 'ãƒ†ãƒƒã‚¯ã‚³ãƒ¼ãƒ—', share: 35, strategy: 'aggressive', power: 100 },
            { name: 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ¯ãƒ¼ã‚¯ã‚¹', share: 29, strategy: 'balanced', power: 85 },
            { name: 'ã‚µã‚¤ãƒãƒ¼ã‚½ãƒ•ãƒˆ', share: 22, strategy: 'defensive', power: 70 }
        ];

        const newsTemplates = [
            '${company}ãŒæ–°è£½å“ã‚’ç™ºè¡¨ï¼æ¥­ç•Œã«è¡æ’ƒ',
            '${company}ã®å£²ä¸ŠãŒ${percent}%å¢—åŠ ',
            'ITæ¥­ç•Œã®æˆé•·ç‡ãŒ${percent}%ã«',
            '${company}ãŒå¤§å‹è²·åã‚’æ¤œè¨ä¸­',
            'æ–°æŠ€è¡“ã®ç™»å ´ã§å¸‚å ´ãŒæ´»æ€§åŒ–',
            '${company}ã®CEOãŒä»Šå¾Œã®æˆ¦ç•¥ã‚’èªã‚‹',
            'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ä¼æ¥­ã®å‚å…¥ãŒç›¸æ¬¡ã'
        ];

        function cloneDefaults() {
            return JSON.parse(JSON.stringify(defaultGameState));
        }

        function overwriteGameState(source) {
            Object.keys(game).forEach(key => delete game[key]);
            Object.assign(game, source);
        }

        function ensureCollections() {
            if (!Array.isArray(game.employees)) game.employees = [];
            if (!Array.isArray(game.products)) game.products = [];
            if (!Array.isArray(game.revenueHistory)) game.revenueHistory = [];
        }

        // Phase 1: ç›¸æ€§ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
        function calculateTeamCompatibility(employees) {
            if (!employees || employees.length < 2) return 1.0;

            let compatibilityScore = 1.0;

            for (let i = 0; i < employees.length; i++) {
                for (let j = i + 1; j < employees.length; j++) {
                    const emp1 = employees[i];
                    const emp2 = employees[j];

                    if (!emp1.personalityKey || !emp2.personalityKey) continue;

                    const personality1 = PERSONALITIES[emp1.personalityKey];
                    const personality2 = PERSONALITIES[emp2.personalityKey];

                    if (!personality1 || !personality2) continue;

                    // ç›¸æ€§è‰¯ã„
                    if (personality1.compatible && personality1.compatible.includes(emp2.personalityKey)) {
                        compatibilityScore += 0.1;
                    }
                    // ç›¸æ€§æ‚ªã„
                    if (personality1.incompatible && personality1.incompatible.includes(emp2.personalityKey)) {
                        compatibilityScore -= 0.15;
                    }
                }
            }

            return Math.max(0.7, Math.min(1.3, compatibilityScore));
        }

        // ã‚ªãƒ•ã‚£ã‚¹ãƒ¬ãƒ™ãƒ«åˆ¤å®šé–¢æ•°
        function determineOfficeLevel() {
            const currentEmployees = game.employees.length;
            const currentMoney = game.money;
            const currentMarketShare = game.marketShare;

            // ãƒ¬ãƒ™ãƒ«5ã‹ã‚‰é †ã«ç¢ºèªï¼ˆæœ€é«˜ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ï¼‰
            for (let level = 5; level >= 1; level--) {
                const conditions = OFFICE_LEVELS[level].unlockConditions;
                if (currentEmployees >= conditions.employees &&
                    currentMoney >= conditions.money &&
                    currentMarketShare >= conditions.marketShare) {
                    return level;
                }
            }
            return 1; // æœ€ä½ãƒ¬ãƒ™ãƒ«
        }

        // ã‚ªãƒ•ã‚£ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«å‘¼ã°ã‚Œã‚‹ï¼‰
        function checkOfficeUpgrade() {
            const newLevel = determineOfficeLevel();
            if (newLevel > game.officeLevel) {
                const oldOffice = OFFICE_LEVELS[game.officeLevel];
                const newOffice = OFFICE_LEVELS[newLevel];
                game.officeLevel = newLevel;

                // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰é€šçŸ¥ã‚’è¡¨ç¤º
                setTimeout(() => {
                    showModal(
                        'ğŸ‰ ã‚ªãƒ•ã‚£ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼',
                        `<div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">
                                ${oldOffice.emoji} â†’ ${newOffice.emoji}
                            </div>
                            <div style="font-size: 20px; font-weight: bold; margin-bottom: 12px; color: #667eea;">
                                ${newOffice.name}
                            </div>
                            <div style="color: #666; margin-bottom: 20px;">
                                ${newOffice.description}
                            </div>
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 12px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“Š æ–°ã—ã„ä¸Šé™</div>
                                <div>æœ€å¤§å¾“æ¥­å“¡æ•°: <strong>${newOffice.maxEmployees}å</strong></div>
                            </div>
                        </div>`
                    );
                }, 800);
                return true;
            }
            return false;
        }

        function normalizeGameState() {
            ensureCollections();
            game.money = Number(game.money) || 0;
            game.turn = Number(game.turn) || 1;
            game.year = Number(game.year) || 2025;
            game.month = Number(game.month) || 1;
            game.week = Number(game.week) || 1;
            game.marketShare = Number(game.marketShare) || 0;
            game.brandPower = Number(game.brandPower) || 0;
            game.monthlyRevenue = Number(game.monthlyRevenue) || 0;
            game.debt = Math.max(0, Number(game.debt) || 0);
            game.isBankrupt = Boolean(game.isBankrupt);
            game.officeLevel = Math.max(1, Math.min(5, Number(game.officeLevel) || 1));
            game.employees.forEach(emp => {
                emp.salary = Number(emp.salary) || 0;
                if (typeof emp.abilities !== 'object' || emp.abilities === null) {
                    emp.abilities = { technical: 0, sales: 0, planning: 0, management: 0 };
                }
                Object.keys(emp.abilities).forEach(key => {
                    emp.abilities[key] = Number(emp.abilities[key]) || 0;
                });
                // Phase 2: æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
                if (!emp.personalityKey || !PERSONALITIES[emp.personalityKey]) {
                    emp.personalityKey = 'logical';
                }
                if (!Array.isArray(emp.subTraits)) {
                    emp.subTraits = [];
                }
                if (!emp.hiddenTrait || !HIDDEN_TRAITS[emp.hiddenTrait]) {
                    const hiddenKeys = Object.keys(HIDDEN_TRAITS);
                    emp.hiddenTrait = hiddenKeys[Math.floor(Math.random() * hiddenKeys.length)];
                }
                if (typeof emp.hiddenTraitRevealed !== 'boolean') {
                    emp.hiddenTraitRevealed = false;
                }
                if (typeof emp.joinedTurn !== 'number') {
                    emp.joinedTurn = game.turn || 1;
                }
                if (!Array.isArray(emp.growthHistory)) {
                    emp.growthHistory = [
                        { turn: emp.joinedTurn, event: 'å…¥ç¤¾', description: 'ä¼šç¤¾ã«å‚åŠ ã—ã¾ã—ãŸ' }
                    ];
                }
                // ğŸ†• éƒ¨ç½²ã¨å½¹è·ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (æ—¢å­˜ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§)
                if (!emp.department || !DEPARTMENTS[emp.department]) {
                    emp.department = 'development';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‹ç™ºéƒ¨
                }
                if (!emp.position || !POSITIONS[emp.position]) {
                    emp.position = 'staff';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ã‚¿ãƒƒãƒ•
                }
                // ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (typeof emp.skillPoints !== 'number') {
                    emp.skillPoints = 0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0ãƒã‚¤ãƒ³ãƒˆ
                }
                if (!Array.isArray(emp.unlockedSkills)) {
                    emp.unlockedSkills = [];  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœªç²å¾—
                }
                // ğŸ­ æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPhase 2.5è¿½åŠ ï¼‰
                if (!emp.temperament || typeof emp.temperament !== 'object') {
                    emp.temperament = generateTemperament(emp.personalityKey);
                }
                // ğŸ“ 30è³‡æ ¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (æ—¢å­˜ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§)
                if (typeof emp.qualification !== 'string' && emp.qualification !== null) {
                    emp.qualification = null;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è³‡æ ¼ãªã—
                }
            });
            game.products.forEach(product => {
                product.sales = Number(product.sales) || 0;
                product.quality = Number(product.quality) || 0;
            });
        }

        function resetGameState() {
            overwriteGameState(cloneDefaults());
            normalizeGameState();
            activePanel = 'overview';
        }

        function addInitialEmployee() {
            ensureCollections();
            if (game.employees.length > 0) return;
            const initialEmployee = {
                id: 1,
                name: 'å±±ç”° å¤ªéƒ',
                personalityKey: 'logical',
                abilities: { technical: 65, sales: 45, planning: 55, management: 50 },
                temperament: generateTemperament('logical'), // æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
                subTraits: ['fast_learner', 'code_reviewer'],
                hiddenTrait: 'late_bloomer',
                hiddenTraitRevealed: false,
                joinedTurn: 1,
                motivation: 75,
                salary: 400000,
                department: 'development',
                position: 'staff',
                qualification: null,  // ğŸ“ åˆæœŸå¾“æ¥­å“¡ã¯ç„¡è³‡æ ¼
                growthHistory: [
                    { turn: 1, event: 'å…¥ç¤¾', description: 'ä¼šç¤¾ã«å‚åŠ ã—ã¾ã—ãŸ' }
                ]
            };
            game.employees.push(initialEmployee);
        }

        async function loadGameFromStorage() {
            try {
                const saved = await storageHelpers.getItem(SAVE_KEY);
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                const merged = Object.assign(cloneDefaults(), parsed);
                overwriteGameState(merged);
                normalizeGameState();
                activePanel = typeof parsed.activePanel === 'string' ? parsed.activePanel : 'overview';
                delete game.activePanel;
                return true;
            } catch (error) {
                console.error('Failed to load save data', error);
                return false;
            }
        }

        /**
         * Phase 2B: ã‚¹ãƒ­ãƒƒãƒˆæŒ‡å®šã§ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
         * @param slotId ã‚¹ãƒ­ãƒƒãƒˆIDï¼ˆ1, 2, 3ï¼‰
         */
        async function initWithSlot(slotId: number) {
            currentSlotId = slotId;
            console.log(`ğŸ“‚ ã‚¹ãƒ­ãƒƒãƒˆ ${slotId} ã‹ã‚‰åˆæœŸåŒ–ä¸­...`);

            // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const slotData = await loadSlotData(slotId);

            if (slotData) {
                // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ: ãƒ­ãƒ¼ãƒ‰
                console.log(`âœ… ã‚¹ãƒ­ãƒƒãƒˆ ${slotId} ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
                const merged = Object.assign(cloneDefaults(), slotData);
                overwriteGameState(merged);
                normalizeGameState();
                activePanel = typeof slotData.activePanel === 'string' ? slotData.activePanel : 'overview';
                delete game.activePanel;

                if (game.employees.length === 0) {
                    addInitialEmployee();
                }
            } else {
                // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ: æ–°è¦ã‚²ãƒ¼ãƒ 
                console.log(`ğŸ†• ã‚¹ãƒ­ãƒƒãƒˆ ${slotId} ã§æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹`);
                resetGameState();
                addInitialEmployee();
            }

            generateNews();
            updateDisplay();
            updateRanking();
            initCharts();
            showPanel(null, activePanel);
        }

        async function init() {
            const loaded = await loadGameFromStorage();
            if (!loaded) {
                resetGameState();
                addInitialEmployee();
            } else {
                normalizeGameState();
                if (game.employees.length === 0) addInitialEmployee();
            }
            generateNews();
            updateDisplay();
            updateRanking();
            initCharts();
            showPanel(null, activePanel);
        }

        function initCharts() {
            // å£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: game.revenueHistory.map((_, i) => `${i + 1}æœˆ`),
                        datasets: [{
                            label: 'å£²ä¸Šï¼ˆä¸‡å††ï¼‰',
                            data: game.revenueHistory.map(r => r / 10000),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // å¸‚å ´ã‚·ã‚§ã‚¢ãƒãƒ£ãƒ¼ãƒˆ
            const marketCtx = document.getElementById('marketChart');
            if (marketCtx) {
                updateMarketChart();
            }
        }

        function initAnimationSystem() {
            console.log('[Game] Initializing animation system...');
            try {
                phaserGame = initCharacterRenderer('game-canvas');

                // Wait for scene to be ready
                setTimeout(() => {
                    characterScene = getCharacterScene(phaserGame!);
                    if (characterScene) {
                        console.log('[Game] Character scene ready, adding existing employees...');
                        syncAllEmployeeSprites();
                    }
                }, 500);
            } catch (error) {
                console.error('[Game] Failed to initialize animation system:', error);
            }
        }

        function syncAllEmployeeSprites() {
            if (!characterScene) return;

            console.log('[Game] Syncing all employee sprites...');
            characterScene.clearAllCharacters();

            const cols = 5;
            game.employees.forEach((emp, index) => {
                const row = Math.floor(index / cols);
                const col = index % cols;
                const x = 100 + col * 150;
                const y = 100 + row * 150;

                characterScene!.addCharacter(String(emp.id), x, y);
                updateEmployeeAnimation(emp);
            });
        }

        function updateEmployeeAnimation(employee: any) {
            if (!characterScene) return;

            let animState: AnimationState = 'idle';

            // Check if employee is assigned to a project
            const isWorking = game.products?.some(p =>
                p.assignedEmployees?.includes(employee.id) ||
                p.assignedEmployees?.some((e: any) => e.id === employee.id)
            );

            if (isWorking) {
                // Check stress level
                const stress = employee.stress || 0;
                animState = stress > 70 ? 'stressed' : 'working';
            }

            characterScene.setAnimation(String(employee.id), animState);
        }

        function syncEmployeeAnimations() {
            if (!characterScene) return;
            game.employees.forEach(emp => updateEmployeeAnimation(emp));
        }

        function updateCharts() {
            if (revenueChart) {
                revenueChart.data.labels = game.revenueHistory.map((_, i) => `${i + 1}æœˆ`);
                revenueChart.data.datasets[0].data = game.revenueHistory.map(r => r / 10000);
                revenueChart.update();
            }

            if (activePanel === 'market') {
                updateMarketChart();
            }
        }

        function updateMarketChart() {
            const marketCtx = document.getElementById('marketChart');
            if (!marketCtx) return;

            if (marketChart) {
                marketChart.destroy();
            }

            const allCompanies = [
                ...competitors.map(c => ({ name: c.name, share: c.share })),
                { name: 'ã‚ãªãŸ', share: game.marketShare }
            ];

            marketChart = new Chart(marketCtx, {
                type: 'doughnut',
                data: {
                    labels: allCompanies.map(c => c.name),
                    datasets: [{
                        data: allCompanies.map(c => c.share),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#ffd700'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateNews() {
            const template = newsTemplates[Math.floor(Math.random() * newsTemplates.length)];
            const company = competitors[Math.floor(Math.random() * competitors.length)].name;
            const percent = Math.floor(Math.random() * 30) + 10;
            const news = template.replace('${company}', company).replace('${percent}', percent);
            document.getElementById('newsText').textContent = 'ğŸ“° ' + news;
        }

        function updateCompetitors() {
            competitors.forEach(comp => {
                if (game.marketShare > 5) {
                    if (comp.strategy === 'aggressive') {
                        comp.power += 5;
                        generateNews();
                    }
                }
                if (comp.strategy === 'aggressive') {
                    comp.share += Math.random() * 2;
                } else if (comp.strategy === 'defensive') {
                    comp.share -= Math.random();
                }
                comp.share = Math.max(5, Math.min(60, comp.share));
                if (comp.share > 40) {
                    game.marketShare = Math.max(0.1, game.marketShare - 0.2);
                    if (game.brandPower > 1) {
                        game.brandPower--;
                    }
                }
            });
        }

        function updateRanking() {
            const allCompanies = [
                ...competitors.map(c => ({ name: c.name, share: c.share })),
                { name: 'ã‚ãªãŸ', share: game.marketShare, isPlayer: true }
            ].sort((a, b) => b.share - a.share);

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4'];
            const rankingHtml = allCompanies.slice(0, 4).map((company, index) =>
                `<div class="rank-item ${company.isPlayer ? 'player' : ''}">
                    <span class="rank-medal">${medals[index]}</span>
                    ${company.name}<br>(${company.share.toFixed(1)}%)
                </div>`
            ).join('');

            document.getElementById('rankingBar').innerHTML = rankingHtml;
        }

        function showPanel(tabButton, panelId) {
            const targetPanelId = panelId || 'overview';
            const targetTab = tabButton || document.querySelector(`.tab[data-panel="${targetPanelId}"]`);
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (targetTab) {
                targetTab.classList.add('active');
            }
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            const panelElement = document.getElementById(targetPanelId);
            if (panelElement) {
                panelElement.classList.add('active');
            }
            activePanel = targetPanelId;
            renderActivePanel();
        }

        function renderOfficeDisplay() {
            const office = OFFICE_LEVELS[game.officeLevel];
            const nextOffice = OFFICE_LEVELS[game.officeLevel + 1];

            let progressPercent = 0;
            if (nextOffice) {
                // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ã®é€²æ—ã‚’è¨ˆç®—ï¼ˆ3ã¤ã®æ¡ä»¶ã®å¹³å‡ï¼‰
                const employeeProgress = Math.min(100, (game.employees.length / nextOffice.unlockConditions.employees) * 100);
                const moneyProgress = Math.min(100, (game.money / nextOffice.unlockConditions.money) * 100);
                const shareProgress = Math.min(100, (game.marketShare / nextOffice.unlockConditions.marketShare) * 100);
                progressPercent = (employeeProgress + moneyProgress + shareProgress) / 3;
            } else {
                progressPercent = 100; // æœ€é«˜ãƒ¬ãƒ™ãƒ«é”æˆ
            }

            const html = `
                <div class="office-display">
                    <div class="office-level-badge">ãƒ¬ãƒ™ãƒ« ${game.officeLevel}/5</div>
                    <div class="office-icon">${office.emoji}</div>
                    <div class="office-name">${office.name}</div>
                    <div class="office-description">${office.description}</div>

                    ${nextOffice ? `
                        <div style="margin-top: 12px; font-size: 13px; color: #666;">
                            ğŸ“ˆ æ¬¡ã®ãƒ¬ãƒ™ãƒ«: ${nextOffice.emoji} ${nextOffice.name}
                        </div>
                        <div class="office-progress">
                            <div class="office-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">
                            é€²æ—: ${Math.floor(progressPercent)}%
                        </div>
                    ` : `
                        <div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #ffd700, #ffed4e); border-radius: 12px;">
                            <strong>ğŸ‰ æœ€é«˜ãƒ¬ãƒ™ãƒ«é”æˆï¼</strong>
                        </div>
                    `}

                    <div class="office-stats">
                        <div class="office-stat">
                            ç¾åœ¨ã®å¾“æ¥­å“¡<br>
                            <strong>${game.employees.length} / ${office.maxEmployees}</strong>
                        </div>
                        <div class="office-stat">
                            ${nextOffice ? `
                                æ¬¡ã®æ¡ä»¶<br>
                                <strong style="font-size: 13px;">
                                    ${nextOffice.unlockConditions.employees}å / ${Math.floor(nextOffice.unlockConditions.money/10000)}ä¸‡ / ${nextOffice.unlockConditions.marketShare}%
                                </strong>
                            ` : `
                                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹<br>
                                <strong>å®Œå…¨åˆ¶è¦‡!</strong>
                            `}
                        </div>
                    </div>
                </div>
            `;

            const officeDisplayEl = document.getElementById('officeDisplay');
            if (officeDisplayEl) {
                officeDisplayEl.innerHTML = html;
            }
        }

        function renderActivePanel() {
            if (activePanel === 'overview') {
                renderOfficeDisplay();
            } else if (activePanel === 'employees') {
                renderEmployees();
            } else if (activePanel === 'departments') {
                renderDepartments();
            } else if (activePanel === 'products') {
                renderProducts();
            } else if (activePanel === 'market') {
                renderMarket();
                updateMarketChart();
            } else if (activePanel === 'finance') {
                renderFinance();
            }
        }

        function updateDisplay() {
            document.getElementById('money').textContent = `${Math.floor(game.money / 10000)}ä¸‡`;
            document.getElementById('employeeCount').textContent = game.employees.length;
            document.getElementById('revenue').textContent = `${Math.floor(game.monthlyRevenue / 10000)}ä¸‡`;
            document.getElementById('gameDate').textContent = `${game.year}å¹´${game.month}æœˆ ç¬¬${game.week}é€±`;
            document.getElementById('marketShare').textContent = `${game.marketShare.toFixed(1)}%`;
            const brandCount = Math.max(0, Math.min(5, Math.floor(game.brandPower)));
            document.getElementById('brand').textContent = brandCount > 0 ? 'â­'.repeat(brandCount) : 'â€•';

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            const moneyPercent = Math.min(100, (game.money / 20000000) * 100);
            document.getElementById('moneyProgress').style.width = moneyPercent + '%';

            const revenuePercent = Math.min(100, (game.monthlyRevenue / 10000000) * 100);
            document.getElementById('revenueProgress').style.width = revenuePercent + '%';

            updateControls();
            updateCharts();
        }

        function updateControls() {
            const disabled = game.isBankrupt;
            document.querySelectorAll('[data-requires-active="true"]').forEach(btn => {
                btn.disabled = disabled;
            });
            const restartBtn = document.getElementById('restartButton');
            if (restartBtn) {
                restartBtn.style.display = disabled ? 'block' : 'none';
            }
        }

        function renderEmployees() {
            const list = document.getElementById('employeeList');
            if (game.employees.length === 0) {
                list.innerHTML = '<div class="empty">å¾“æ¥­å“¡ãŒã„ã¾ã›ã‚“</div>';
                return;
            }

            // ãƒãƒ¼ãƒ ç›¸æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—
            const teamCompatibility = calculateTeamCompatibility(game.employees);

            list.innerHTML = `
                ${game.employees.length > 1 ? `
                    <div class="info-box" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">ğŸ¤ ãƒãƒ¼ãƒ ç›¸æ€§</span>
                            <span style="font-weight: bold; color: ${teamCompatibility >= 1.0 ? '#4caf50' : '#ff9800'};">
                                ${(teamCompatibility * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>
                ` : ''}
                ${game.employees.map((emp, empIndex) => {
                    const personality = PERSONALITIES[emp.personalityKey] || PERSONALITIES.logical;
                    return `
                        <div class="employee" onclick="showEmployeeDetail(game.employees[${empIndex}])">
                            <div class="employee-header">
                                <div class="employee-name">
                                    <span class="icon-badge">ğŸ‘¤</span>
                                    ${emp.name}
                                </div>
                                <span class="personality">${personality.emoji} ${personality.name}</span>
                            </div>
                            <div style="margin: 8px 0; display: flex; gap: 6px; flex-wrap: wrap;">
                                <span class="department-badge">${DEPARTMENTS[emp.department]?.emoji || 'ğŸ’»'} ${DEPARTMENTS[emp.department]?.name || 'é–‹ç™ºéƒ¨'}</span>
                                <span class="position-badge">${POSITIONS[emp.position]?.emoji || 'ğŸ‘¤'} ${POSITIONS[emp.position]?.name || 'ã‚¹ã‚¿ãƒƒãƒ•'}</span>
                            </div>
                            ${emp.subTraits && emp.subTraits.length > 0 ? `
                                <div style="margin: 12px 0; display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${emp.subTraits.map(traitKey => {
                                        const trait = SUB_TRAITS[traitKey];
                                        if (!trait) return '';
                                        return `<span style="background: ${trait.negative ? 'rgba(244, 67, 54, 0.15)' : 'rgba(76, 175, 80, 0.15)'};
                                                       color: ${trait.negative ? '#f44336' : '#4caf50'};
                                                       padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                            ${trait.emoji} ${trait.name}
                                        </span>`;
                                    }).join('')}
                                </div>
                            ` : ''}
                            ${emp.hiddenTraitRevealed ? `
                                <div style="margin: 8px 0;">
                                    <span style="background: linear-gradient(135deg, #ffd700, #ffed4e);
                                           padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; color: #333;">
                                        âœ¨ ${HIDDEN_TRAITS[emp.hiddenTrait].emoji} ${HIDDEN_TRAITS[emp.hiddenTrait].name}
                                    </span>
                                </div>
                            ` : ''}
                            <div class="abilities">
                                <div class="ability">
                                    <span class="ability-name">âš™ï¸ æŠ€è¡“: ${emp.abilities.technical}</span>
                                    <div class="ability-bar">
                                        <div class="ability-bar-fill" style="width: ${emp.abilities.technical}%"></div>
                                    </div>
                                </div>
                                <div class="ability">
                                    <span class="ability-name">ğŸ’¼ å–¶æ¥­: ${emp.abilities.sales}</span>
                                    <div class="ability-bar">
                                        <div class="ability-bar-fill" style="width: ${emp.abilities.sales}%"></div>
                                    </div>
                                </div>
                                <div class="ability">
                                    <span class="ability-name">ğŸ“‹ ä¼ç”»: ${emp.abilities.planning}</span>
                                    <div class="ability-bar">
                                        <div class="ability-bar-fill" style="width: ${emp.abilities.planning}%"></div>
                                    </div>
                                </div>
                                <div class="ability">
                                    <span class="ability-name">ğŸ‘” ç®¡ç†: ${emp.abilities.management}</span>
                                    <div class="ability-bar">
                                        <div class="ability-bar-fill" style="width: ${emp.abilities.management}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 8px; color: #667eea; font-weight: 600;">ğŸ’° æœˆçµ¦: ${Math.floor(emp.salary / 10000)}ä¸‡å††</div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderProducts() {
            const list = document.getElementById('productList');
            if (game.products.length === 0) {
                list.innerHTML = '<div class="empty">è£½å“ãŒã‚ã‚Šã¾ã›ã‚“<br>ğŸ’¡ æ–°è£½å“ã‚’é–‹ç™ºã—ã¾ã—ã‚‡ã†!</div>';
                return;
            }
            list.innerHTML = game.products.map(product => `
                <div class="product">
                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">ğŸ“¦ ${product.name}</div>
                    <div class="product-quality">â­ å“è³ª: ${product.quality}%</div>
                    <div style="margin-top: 8px; font-weight: 600;">ğŸ’µ ç´¯è¨ˆå£²ä¸Š: ${Math.floor(product.sales / 10000)}ä¸‡å††</div>
                </div>
            `).join('');
        }

        function renderMarket() {
            const info = document.getElementById('marketInfo');
            info.innerHTML = `
                <h4 style="margin-top: 20px; margin-bottom: 12px; color: #667eea;">ğŸ† ç«¶åˆä¼æ¥­</h4>
                ${competitors.map(comp => `
                    <div class="competitor">
                        <strong style="font-size: 15px;">ğŸ¢ ${comp.name}</strong>
                        <div style="margin-top: 6px;">å¸‚å ´ã‚·ã‚§ã‚¢: <strong>${comp.share.toFixed(1)}%</strong></div>
                        <div style="margin-top: 4px; font-size: 12px; color: #666;">
                            æˆ¦ç•¥: ${comp.strategy === 'aggressive' ? 'âš”ï¸ æ”»æ’ƒçš„' :
                                   comp.strategy === 'balanced' ? 'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹å‹' : 'ğŸ›¡ï¸ å®ˆå‚™çš„'}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderFinance() {
            const info = document.getElementById('financeInfo');
            const salaryTotal = game.employees.reduce((sum, emp) => sum + emp.salary, 0);
            const interestPreview = game.debt > 0 ? Math.floor(game.debt * LOAN_INTEREST_RATE) : 0;
            info.innerHTML = `
                <div class="info-box">
                    <div>
                        <span>ğŸ“Š å£²ä¸Šé«˜</span>
                        <strong>${Math.floor(game.monthlyRevenue / 10000)}ä¸‡å††</strong>
                    </div>
                    <div>
                        <span>ğŸ‘¥ äººä»¶è²»</span>
                        <strong>${Math.floor(salaryTotal / 10000)}ä¸‡å††</strong>
                    </div>
                    <div style="border-top: 2px solid #667eea; padding-top: 8px; margin-top: 8px;">
                        <span>ğŸ’° ç´”åˆ©ç›Š</span>
                        <strong style="color: ${(game.monthlyRevenue - salaryTotal - interestPreview) >= 0 ? '#4caf50' : '#f44336'}">
                            ${Math.floor((game.monthlyRevenue - salaryTotal - interestPreview) / 10000)}ä¸‡å††
                        </strong>
                    </div>
                    ${game.debt ? `<div style="margin-top: 8px;">
                        <span>ğŸ¦ å€Ÿé‡‘æ®‹é«˜</span>
                        <strong style="color: #ff9800;">${Math.floor(game.debt / 10000)}ä¸‡å††</strong>
                    </div>` : ''}
                    ${interestPreview ? `<div>
                        <span>ğŸ“ˆ æ¬¡æœˆåˆ©æ¯è¦‹è¾¼</span>
                        <strong>${Math.floor(interestPreview / 10000)}ä¸‡å††</strong>
                    </div>` : ''}
                </div>
            `;
        }

        // ğŸ†• éƒ¨ç½²æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function renderDepartments() {
            const grid = document.getElementById('departmentsGrid');

            if (game.employees.length === 0) {
                grid.innerHTML = '<div class="empty">å¾“æ¥­å“¡ãŒã¾ã ã„ã¾ã›ã‚“</div>';
                return;
            }

            // éƒ¨ç½²ã”ã¨ã®å¾“æ¥­å“¡ã‚’é›†è¨ˆ
            const departmentStats = {};
            Object.keys(DEPARTMENTS).forEach(deptKey => {
                departmentStats[deptKey] = {
                    employees: [],
                    totalAbility: 0,
                    manager: null
                };
            });

            // å¾“æ¥­å“¡ã‚’éƒ¨ç½²ã”ã¨ã«æŒ¯ã‚Šåˆ†ã‘
            game.employees.forEach(emp => {
                const deptKey = emp.department || 'development';
                if (departmentStats[deptKey]) {
                    departmentStats[deptKey].employees.push(emp);

                    // å¹³å‡èƒ½åŠ›å€¤ã‚’è¨ˆç®—
                    const avgAbility = (emp.abilities.technical + emp.abilities.sales +
                                       emp.abilities.planning + emp.abilities.management) / 4;
                    departmentStats[deptKey].totalAbility += avgAbility;

                    // ç®¡ç†è·ã‚’æ¢ã™ï¼ˆéƒ¨é•· > èª²é•· > ã‚·ãƒ‹ã‚¢ï¼‰
                    const empPosition = POSITIONS[emp.position];
                    const currentManager = departmentStats[deptKey].manager;
                    if (!currentManager ||
                        (empPosition && empPosition.requiredAbility > (POSITIONS[currentManager.position]?.requiredAbility || 0))) {
                        departmentStats[deptKey].manager = emp;
                    }
                }
            });

            // éƒ¨ç½²ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const departmentCardsHtml = Object.keys(DEPARTMENTS).map(deptKey => {
                const dept = DEPARTMENTS[deptKey];
                const stats = departmentStats[deptKey];
                const empCount = stats.employees.length;
                const avgAbility = empCount > 0 ? Math.round(stats.totalAbility / empCount) : 0;

                // åŠ¹ç‡æ€§è¨ˆç®—ï¼ˆå¹³å‡èƒ½åŠ›å€¤ã«åŸºã¥ãï¼‰
                const efficiency = Math.min(100, avgAbility * 1.2);
                const efficiencyColor = efficiency >= 80 ? '#4caf50' : efficiency >= 50 ? '#ff9800' : '#f44336';

                return `
                    <div class="department-card">
                        <div class="department-card-header">
                            <div style="font-size: 32px; margin-bottom: 8px;">${dept.emoji}</div>
                            <div style="font-size: 18px; font-weight: 700; color: #333;">${dept.name}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">${dept.description}</div>
                        </div>

                        <div class="department-stats">
                            <div class="stat-item">
                                <div class="department-stat-label">ğŸ‘¥ äººæ•°</div>
                                <div class="department-stat-value">${empCount}å</div>
                            </div>
                            <div class="stat-item">
                                <div class="department-stat-label">ğŸ’ª å¹³å‡èƒ½åŠ›</div>
                                <div class="department-stat-value">${avgAbility}</div>
                            </div>
                        </div>

                        <div class="department-manager">
                            <div style="font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 6px;">ğŸ‘” è²¬ä»»è€…</div>
                            ${stats.manager ? `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${PERSONALITIES[stats.manager.personalityKey]?.emoji || 'ğŸ‘¤'}</span>
                                    <div>
                                        <div style="font-size: 13px; font-weight: 600;">${escapeHtml(stats.manager.name)}</div>
                                        <div style="font-size: 11px; color: #999;">
                                            ${POSITIONS[stats.manager.position]?.emoji || 'ğŸ‘¤'} ${POSITIONS[stats.manager.position]?.name || 'ã‚¹ã‚¿ãƒƒãƒ•'}
                                        </div>
                                    </div>
                                </div>
                            ` : '<div style="font-size: 12px; color: #999;">æœªé…ç½®</div>'}
                        </div>

                        <div class="department-efficiency">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 12px; font-weight: 600; color: #667eea;">ğŸ“Š åŠ¹ç‡æ€§</span>
                                <span style="font-size: 14px; font-weight: 700; color: ${efficiencyColor};">${Math.round(efficiency)}%</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.05); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${efficiencyColor}; height: 100%; width: ${efficiency}%;
                                           transition: width 0.3s ease; border-radius: 4px;"></div>
                            </div>
                        </div>

                        ${empCount > 0 ? `
                            <div class="department-employees">
                                <div style="font-size: 11px; color: #999; margin-bottom: 6px;">æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${stats.employees.slice(0, 8).map(emp =>
                                        `<span style="font-size: 16px;" title="${escapeHtml(emp.name)}">
                                            ${PERSONALITIES[emp.personalityKey]?.emoji || 'ğŸ‘¤'}
                                        </span>`
                                    ).join('')}
                                    ${empCount > 8 ? `<span style="font-size: 11px; color: #999; align-self: center;">+${empCount - 8}</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            grid.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    ${departmentCardsHtml}
                </div>
            `;
        }

        function requireCompanyActive() {
            if (!game.isBankrupt) return true;
            showModal('æ“ä½œä¸å¯', 'å€’ç”£çŠ¶æ…‹ã®ãŸã‚æ“ä½œã§ãã¾ã›ã‚“ã€‚å†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
            return false;
        }

        // å¾“æ¥­å“¡å€™è£œã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function generateCandidate() {
            const names = ['ä½è—¤', 'éˆ´æœ¨', 'é«˜æ©‹', 'ç”°ä¸­', 'ä¼Šè—¤', 'æ¸¡è¾º', 'å±±æœ¬', 'ä¸­æ‘', 'å°æ—', 'åŠ è—¤'];
            const firstNames = ['å¤ªéƒ', 'èŠ±å­', 'ä¸€éƒ', 'ç¾å’²', 'å¥å¤ª', 'å„ªå­', 'ç¿”å¤ª', 'æ„›', 'å¤§è¼”', 'ç¶¾ä¹ƒ'];

            const personalityKeys = Object.keys(PERSONALITIES);
            const selectedPersonalityKey = personalityKeys[Math.floor(Math.random() * personalityKeys.length)];

            const subTraitKeys = Object.keys(SUB_TRAITS);
            const numSubTraits = 2 + Math.floor(Math.random() * 2);
            const selectedSubTraits = [];
            const shuffledSubTraits = [...subTraitKeys].sort(() => Math.random() - 0.5);
            for (let i = 0; i < numSubTraits && i < shuffledSubTraits.length; i++) {
                selectedSubTraits.push(shuffledSubTraits[i]);
            }

            const hiddenTraitKeys = Object.keys(HIDDEN_TRAITS);
            const selectedHiddenTrait = hiddenTraitKeys[Math.floor(Math.random() * hiddenTraitKeys.length)];

            const departmentKeys = Object.keys(DEPARTMENTS);
            const selectedDepartmentKey = departmentKeys[Math.floor(Math.random() * departmentKeys.length)];
            const selectedDepartment = DEPARTMENTS[selectedDepartmentKey];

            // === ğŸ†• 30è³‡æ ¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ ===
            const candidate = {
                id: Date.now() + Math.random(),
                name: names[Math.floor(Math.random() * names.length)] + ' ' +
                      firstNames[Math.floor(Math.random() * firstNames.length)],
                age: 22 + Math.floor(Math.random() * 18), // 22-40æ­³
                personalityKey: selectedPersonalityKey,
                abilities: {
                    technical: 30 + Math.floor(Math.random() * 50),
                    sales: 30 + Math.floor(Math.random() * 50),
                    planning: 30 + Math.floor(Math.random() * 50),
                    management: 30 + Math.floor(Math.random() * 50)
                },
                temperament: generateTemperament(selectedPersonalityKey), // æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
                subTraits: selectedSubTraits,
                hiddenTrait: selectedHiddenTrait,
                hiddenTraitRevealed: false,
                joinedTurn: game.turn,
                motivation: 70,
                department: selectedDepartmentKey,
                position: 'staff',
                skillPoints: 0,
                unlockedSkills: [],
                growthHistory: [
                    { turn: game.turn, event: 'å…¥ç¤¾', description: `${selectedDepartment.emoji} ${selectedDepartment.name}ã«é…å±ã•ã‚Œã¾ã—ãŸ` }
                ]
            };

            // è³‡æ ¼é¸æŠï¼ˆå…¨ä½“ã§ç´„5%ãŒä¿æœ‰ã€é›£é–¢è³‡æ ¼ã¯0.5%ä»¥ä¸‹ï¼‰
            if (typeof selectQualificationForCandidate === 'function') {
                candidate.qualification = selectQualificationForCandidate(candidate);
            } else {
                candidate.qualification = null;
            }

            // è³‡æ ¼ã‚’è€ƒæ…®ã—ãŸçµ¦ä¸è¨ˆç®—
            if (typeof calculateCandidateSalaryWithQualification === 'function') {
                candidate.salary = calculateCandidateSalaryWithQualification(candidate, candidate.qualification);
            } else {
                candidate.salary = 300000 + Math.floor(Math.random() * 200000);
            }

            return candidate;
        }

        // ğŸ¢ éƒ¨ç½²åˆ¥å€™è£œè€…ç”Ÿæˆé–¢æ•°ï¼ˆPhase 2è¿½åŠ ï¼‰
        function generateCandidateForDepartment(departmentKey) {
            const names = ['ä½è—¤', 'éˆ´æœ¨', 'é«˜æ©‹', 'ç”°ä¸­', 'ä¼Šè—¤', 'æ¸¡è¾º', 'å±±æœ¬', 'ä¸­æ‘', 'å°æ—', 'åŠ è—¤'];
            const firstNames = ['å¤ªéƒ', 'èŠ±å­', 'ä¸€éƒ', 'ç¾å’²', 'å¥å¤ª', 'å„ªå­', 'ç¿”å¤ª', 'æ„›', 'å¤§è¼”', 'ç¶¾ä¹ƒ'];

            const department = DEPARTMENTS[departmentKey];
            if (!department) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®generateCandidate()ã‚’ä½¿ç”¨
                return generateCandidate();
            }

            const personalityKeys = Object.keys(PERSONALITIES);
            const selectedPersonalityKey = personalityKeys[Math.floor(Math.random() * personalityKeys.length)];

            const subTraitKeys = Object.keys(SUB_TRAITS);
            const numSubTraits = 2 + Math.floor(Math.random() * 2);
            const selectedSubTraits = [];
            const shuffledSubTraits = [...subTraitKeys].sort(() => Math.random() - 0.5);
            for (let i = 0; i < numSubTraits && i < shuffledSubTraits.length; i++) {
                selectedSubTraits.push(shuffledSubTraits[i]);
            }

            const hiddenTraitKeys = Object.keys(HIDDEN_TRAITS);
            const selectedHiddenTrait = hiddenTraitKeys[Math.floor(Math.random() * hiddenTraitKeys.length)];

            // éƒ¨ç½²ã«å¿œã˜ãŸã‚¹ã‚­ãƒ«ç”Ÿæˆï¼ˆé‡ã¿ä»˜ã‘é©ç”¨ï¼‰
            const abilities = {};
            Object.keys(department.abilityWeights).forEach(abilityKey => {
                const weight = department.abilityWeights[abilityKey];
                abilities[abilityKey] = weight.min + Math.floor(Math.random() * (weight.max - weight.min + 1));
            });

            // æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆéƒ¨ç½²ã®é‡ã¿ä»˜ã‘ã‚’é©ç”¨ï¼‰
            const baseTemperament = generateTemperament(selectedPersonalityKey);
            const temperament = { ...baseTemperament };

            if (department.temperamentWeights) {
                Object.keys(department.temperamentWeights).forEach(traitKey => {
                    const adjustment = department.temperamentWeights[traitKey];
                    temperament[traitKey] = Math.max(0, Math.min(100, temperament[traitKey] + adjustment));
                });
            }

            const candidate = {
                id: Date.now() + Math.random(),
                name: names[Math.floor(Math.random() * names.length)] + ' ' +
                      firstNames[Math.floor(Math.random() * firstNames.length)],
                age: 22 + Math.floor(Math.random() * 18),
                personalityKey: selectedPersonalityKey,
                abilities: abilities,
                temperament: temperament,
                subTraits: selectedSubTraits,
                hiddenTrait: selectedHiddenTrait,
                hiddenTraitRevealed: false,
                joinedTurn: game.turn,
                motivation: 70,
                department: departmentKey,
                position: 'staff',
                skillPoints: 0,
                unlockedSkills: [],
                growthHistory: [
                    { turn: game.turn, event: 'å…¥ç¤¾', description: `${department.emoji} ${department.name}ã«é…å±ã•ã‚Œã¾ã—ãŸ` }
                ]
            };

            // è³‡æ ¼é¸æŠ
            if (typeof selectQualificationForCandidate === 'function') {
                candidate.qualification = selectQualificationForCandidate(candidate);
            } else {
                candidate.qualification = null;
            }

            // è³‡æ ¼ã‚’è€ƒæ…®ã—ãŸçµ¦ä¸è¨ˆç®—
            if (typeof calculateCandidateSalaryWithQualification === 'function') {
                candidate.salary = calculateCandidateSalaryWithQualification(candidate, candidate.qualification);
            } else {
                candidate.salary = 300000 + Math.floor(Math.random() * 200000);
            }

            return candidate;
        }

        function showHiring() {
            if (!requireCompanyActive()) return;

            // ã‚ªãƒ•ã‚£ã‚¹ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹å¾“æ¥­å“¡ä¸Šé™ãƒã‚§ãƒƒã‚¯
            const currentOffice = OFFICE_LEVELS[game.officeLevel];
            if (game.employees.length >= currentOffice.maxEmployees) {
                const nextOffice = OFFICE_LEVELS[game.officeLevel + 1];
                const upgradeInfo = nextOffice ?
                    `<div style="margin-top: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 6px;">ğŸ“ˆ æ¬¡ã®ãƒ¬ãƒ™ãƒ«æ¡ä»¶</div>
                        <div style="font-size: 13px;">
                            ${nextOffice.emoji} ${nextOffice.name}<br>
                            å¿…è¦: å¾“æ¥­å“¡${nextOffice.unlockConditions.employees}åã€è³‡é‡‘${Math.floor(nextOffice.unlockConditions.money/10000)}ä¸‡å††ã€ã‚·ã‚§ã‚¢${nextOffice.unlockConditions.marketShare}%
                        </div>
                    </div>` : '';
                showModal(
                    'ğŸ¢ æ¡ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸ',
                    `ç¾åœ¨ã®ã‚ªãƒ•ã‚£ã‚¹ï¼ˆ${currentOffice.emoji} ${currentOffice.name}ï¼‰ã§ã¯ã€ã“ã‚Œä»¥ä¸Šå¾“æ¥­å“¡ã‚’æ¡ç”¨ã§ãã¾ã›ã‚“ã€‚<br>
                    <br>æœ€å¤§å¾“æ¥­å“¡æ•°: <strong>${currentOffice.maxEmployees}å</strong>${upgradeInfo}`
                );
                return;
            }

            // ğŸ¢ éƒ¨ç½²é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆPhase 2è¿½åŠ ï¼‰
            showDepartmentSelectionForHiring();
        }

        // ğŸ¢ éƒ¨ç½²é¸æŠç”»é¢è¡¨ç¤ºï¼ˆPhase 2è¿½åŠ ï¼‰
        function showDepartmentSelectionForHiring() {
            // å„éƒ¨ç½²ã®ç¾åœ¨ã®å¾“æ¥­å“¡æ•°ã‚’é›†è¨ˆ
            const departmentCounts = {};
            Object.keys(DEPARTMENTS).forEach(key => {
                departmentCounts[key] = game.employees.filter(emp => emp.department === key).length;
            });

            const departmentCardsHtml = Object.keys(DEPARTMENTS).map(deptKey => {
                const dept = DEPARTMENTS[deptKey];
                const count = departmentCounts[deptKey] || 0;
                return `
                    <div class="department-card" onclick="showHiringForDepartment('${deptKey}')" style="
                        padding: 20px;
                        margin: 10px 0;
                        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
                        border: 2px solid rgba(102, 126, 234, 0.2);
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s;
                    " onmouseover="this.style.borderColor='rgba(102, 126, 234, 0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                       onmouseout="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.transform=''; this.style.boxShadow=''">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-size: 24px;">${dept.emoji}</div>
                            <div style="font-size: 13px; color: #667eea; font-weight: 600;">ç¾åœ¨: ${count}å</div>
                        </div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">${dept.name}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">${dept.description}</div>
                        <div style="font-size: 11px; color: #999;">
                            ä¸»è¦ã‚¹ã‚­ãƒ«: ${dept.primaryAbility === 'technical' ? 'æŠ€è¡“åŠ›' :
                                          dept.primaryAbility === 'sales' ? 'å–¶æ¥­åŠ›' :
                                          dept.primaryAbility === 'planning' ? 'ä¼ç”»åŠ›' : 'ç®¡ç†åŠ›'}
                        </div>
                    </div>
                `;
            }).join('');

            const modalBody = `
                <div style="margin-bottom: 20px; padding: 14px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                    <div style="font-size: 13px; color: #666;">
                        ğŸ“Š æ¡ç”¨ã™ã‚‹éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚éƒ¨ç½²ã«é©ã—ãŸå¿œå‹Ÿè€…ãŒé›†ã¾ã‚Šã¾ã™ã€‚
                    </div>
                </div>
                ${departmentCardsHtml}
                <div style="margin-top: 20px; font-size: 11px; color: #999; text-align: center;">
                    ğŸ’° æ¡ç”¨å‹Ÿé›†è²»: 10ä¸‡å††ï¼ˆéƒ¨ç½²é¸æŠå¾Œã«æ”¯æ‰•ã„ï¼‰
                </div>
            `;

            showModal('ğŸ¢ éƒ¨ç½²åˆ¥æ¡ç”¨æ´»å‹•', modalBody, true);
        }

        // ğŸ¢ ç‰¹å®šéƒ¨ç½²ã®æ¡ç”¨æ´»å‹•ï¼ˆPhase 2è¿½åŠ ï¼‰
        function showHiringForDepartment(departmentKey) {
            closeModal(); // éƒ¨ç½²é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

            // ğŸ“‹ æ¡ç”¨å‹Ÿé›†ã‚³ã‚¹ãƒˆï¼ˆæ±‚äººåºƒå‘Šè²»ï¼‰
            const recruitmentCost = 100000; // 10ä¸‡å††

            if (game.money < recruitmentCost) {
                showModal('æ¡ç”¨å¤±æ•—', `è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆæ¡ç”¨å‹Ÿé›†è²»: ${recruitmentCost / 10000}ä¸‡å††å¿…è¦ï¼‰`);
                return;
            }

            // æ¡ç”¨å‹Ÿé›†è²»ã‚’æ”¯æ‰•ã†
            game.money -= recruitmentCost;
            updateDisplay();

            // ğŸ†• éƒ¨ç½²ã«é©ã—ãŸ3åã®å€™è£œè€…ã‚’ç”Ÿæˆ
            const candidates = [
                generateCandidateForDepartment(departmentKey),
                generateCandidateForDepartment(departmentKey),
                generateCandidateForDepartment(departmentKey)
            ];
            window.hireCandidates = candidates; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜

            // å€™è£œè€…ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
            const candidateCardsHtml = candidates.map((candidate, index) => {
                const personality = PERSONALITIES[candidate.personalityKey];
                const avgAbility = Math.round((candidate.abilities.technical + candidate.abilities.sales +
                                                candidate.abilities.planning + candidate.abilities.management) / 4);

                // === ğŸ†• è³‡æ ¼ãƒãƒƒã‚¸ã®è¡¨ç¤º ===
                const qualificationBadge = (typeof renderQualificationBadge === 'function' && candidate.qualification) ?
                    renderQualificationBadge(candidate.qualification) : '';
                const qualificationDetails = (typeof renderQualificationDetails === 'function' && candidate.qualification) ?
                    renderQualificationDetails(candidate.qualification) : '';

                return `
                    <div class="candidate-card-hiring ${candidate.qualification ? 'has-qualification' : ''}" data-index="${index}">
                        <div class="candidate-header">
                            <div style="font-size: 28px; margin-bottom: 6px;">${personality.emoji}</div>
                            <div class="candidate-name">${escapeHtml(candidate.name)} (${candidate.age}æ­³)</div>
                            <div class="candidate-personality"
                                 onclick="showPersonalityDetail('${candidate.personalityKey}')"
                                 style="cursor: pointer; text-decoration: underline; text-decoration-style: dotted;"
                                 title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º">
                                ${personality.name}
                            </div>
                            ${qualificationBadge}
                        </div>

                        <div class="candidate-abilities">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">ğŸ’ª èƒ½åŠ›å€¤ (å¹³å‡: ${avgAbility})</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px;">
                                <div>âš™ï¸ æŠ€è¡“: <strong>${candidate.abilities.technical}</strong></div>
                                <div>ğŸ’¼ å–¶æ¥­: <strong>${candidate.abilities.sales}</strong></div>
                                <div>ğŸ“‹ ä¼ç”»: <strong>${candidate.abilities.planning}</strong></div>
                                <div>ğŸ‘” ç®¡ç†: <strong>${candidate.abilities.management}</strong></div>
                            </div>
                        </div>

                        <div class="candidate-traits">
                            <div style="font-weight: 600; margin-bottom: 5px; font-size: 12px;">
                                ğŸŒŸ ç‰¹æ€§
                                <span style="font-size: 10px; color: #999; font-weight: normal;">ï¼ˆã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼‰</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${candidate.subTraits.map(traitKey => {
                                    const trait = SUB_TRAITS[traitKey];
                                    return `<span class="trait-badge-small ${trait.negative ? 'negative' : 'positive'}"
                                                  onclick="showTraitDetail('${traitKey}')"
                                                  style="cursor: pointer; transition: transform 0.2s;"
                                                  onmouseover="this.style.transform='scale(1.1)'"
                                                  onmouseout="this.style.transform='scale(1)'"
                                                  title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°: ${trait.name}">${trait.emoji}</span>`;
                                }).join('')}
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">â€» éš ã‚Œç‰¹æ€§ã‚ã‚Š</div>
                        </div>

                        ${qualificationDetails}

                        <div class="candidate-salary" style="margin: 8px 0;">
                            ğŸ’° ${Math.floor(candidate.salary / 10000)}ä¸‡å††/æœˆ
                        </div>

                        <button class="btn-primary candidate-hire-btn" onclick="hireSelectedCandidate(${index})"
                                style="width: 100%; margin-top: 8px;">
                            âœ… æ¡ç”¨ã™ã‚‹
                        </button>
                    </div>
                `;
            }).join('');

            const html = `
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px; text-align: center; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                        <div style="font-size: 14px; color: #333; font-weight: 600;">ğŸ’¼ 3åã®å€™è£œè€…ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„</div>
                        <div style="font-size: 12px; color: #666; margin-top: 6px;">
                            ğŸ“‹ æ¡ç”¨å‹Ÿé›†è²»: ${recruitmentCost / 10000}ä¸‡å†† <span style="color: #4caf50;">âœ“ æ”¯æ‰•æ¸ˆ</span>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">
                            â€» æ¡ç”¨æ™‚ã«è¿½åŠ ã§çµ¦ä¸3ãƒ¶æœˆåˆ†ãŒå¿…è¦ã§ã™
                        </div>
                    </div>
                    <div class="candidates-grid">
                        ${candidateCardsHtml}
                    </div>
                </div>
            `;

            showModal('ğŸ“‹ æ¡ç”¨æ´»å‹•', html, true);
        }

        // ğŸ†• é¸æŠã—ãŸå€™è£œè€…ã‚’æ¡ç”¨ã™ã‚‹
        function hireSelectedCandidate(index) {
            const candidate = window.hireCandidates[index];
            if (!candidate) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            hireEmployee(candidate);
        }

        // ğŸ†• è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦æ¡ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¾©å…ƒ
        function closeDetailModal() {
            if (window.hireCandidates && window.hireCandidates.length > 0) {
                // æ¡ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
                restoreHiringModal();
            } else {
                // é€šå¸¸ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeModal();
            }
        }

        // ğŸ†• æ¡ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¾©å…ƒï¼ˆå€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†æ§‹ç¯‰ï¼‰
        function restoreHiringModal() {
            const candidates = window.hireCandidates;
            if (!candidates || candidates.length === 0) {
                closeModal();
                return;
            }

            const recruitmentCost = 100000; // æ¡ç”¨å‹Ÿé›†è²»

            // å€™è£œè€…ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆï¼ˆshowHiringé–¢æ•°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            const candidateCardsHtml = candidates.map((candidate, index) => {
                const personality = PERSONALITIES[candidate.personalityKey];
                const avgAbility = Math.round((candidate.abilities.technical + candidate.abilities.sales +
                                                candidate.abilities.planning + candidate.abilities.management) / 4);

                const qualificationBadge = (typeof renderQualificationBadge === 'function' && candidate.qualification) ?
                    renderQualificationBadge(candidate.qualification) : '';
                const qualificationDetails = (typeof renderQualificationDetails === 'function' && candidate.qualification) ?
                    renderQualificationDetails(candidate.qualification) : '';

                return `
                    <div class="candidate-card-hiring ${candidate.qualification ? 'has-qualification' : ''}" data-index="${index}">
                        <div class="candidate-header">
                            <div style="font-size: 28px; margin-bottom: 6px;">${personality.emoji}</div>
                            <div class="candidate-name">${escapeHtml(candidate.name)} (${candidate.age}æ­³)</div>
                            <div class="candidate-personality"
                                 onclick="showPersonalityDetail('${candidate.personalityKey}')"
                                 style="cursor: pointer; text-decoration: underline; text-decoration-style: dotted;"
                                 title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º">
                                ${personality.name}
                            </div>
                            ${qualificationBadge}
                        </div>

                        <div class="candidate-abilities">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">ğŸ’ª èƒ½åŠ›å€¤ (å¹³å‡: ${avgAbility})</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px;">
                                <div>âš™ï¸ æŠ€è¡“: <strong>${candidate.abilities.technical}</strong></div>
                                <div>ğŸ’¼ å–¶æ¥­: <strong>${candidate.abilities.sales}</strong></div>
                                <div>ğŸ“‹ ä¼ç”»: <strong>${candidate.abilities.planning}</strong></div>
                                <div>ğŸ‘” ç®¡ç†: <strong>${candidate.abilities.management}</strong></div>
                            </div>
                        </div>

                        <div class="candidate-traits">
                            <div style="font-weight: 600; margin-bottom: 5px; font-size: 12px;">
                                ğŸŒŸ ç‰¹æ€§
                                <span style="font-size: 10px; color: #999; font-weight: normal;">ï¼ˆã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼‰</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${candidate.subTraits.map(traitKey => {
                                    const trait = SUB_TRAITS[traitKey];
                                    return `<span class="trait-badge-small ${trait.negative ? 'negative' : 'positive'}"
                                                  onclick="showTraitDetail('${traitKey}')"
                                                  style="cursor: pointer; transition: transform 0.2s;"
                                                  onmouseover="this.style.transform='scale(1.1)'"
                                                  onmouseout="this.style.transform='scale(1)'"
                                                  title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°: ${trait.name}">${trait.emoji}</span>`;
                                }).join('')}
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">â€» éš ã‚Œç‰¹æ€§ã‚ã‚Š</div>
                        </div>

                        ${qualificationDetails}

                        <div class="candidate-salary" style="margin: 8px 0;">
                            ğŸ’° ${Math.floor(candidate.salary / 10000)}ä¸‡å††/æœˆ
                        </div>

                        <button class="btn-primary candidate-hire-btn" onclick="hireSelectedCandidate(${index})"
                                style="width: 100%; margin-top: 8px;">
                            âœ… æ¡ç”¨ã™ã‚‹
                        </button>
                    </div>
                `;
            }).join('');

            const html = `
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px; text-align: center; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                        <div style="font-size: 14px; color: #333; font-weight: 600;">ğŸ’¼ 3åã®å€™è£œè€…ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„</div>
                        <div style="font-size: 12px; color: #666; margin-top: 6px;">
                            ğŸ“‹ æ¡ç”¨å‹Ÿé›†è²»: ${recruitmentCost / 10000}ä¸‡å†† <span style="color: #4caf50;">âœ“ æ”¯æ‰•æ¸ˆ</span>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">
                            â€» æ¡ç”¨æ™‚ã«è¿½åŠ ã§çµ¦ä¸3ãƒ¶æœˆåˆ†ãŒå¿…è¦ã§ã™
                        </div>
                    </div>
                    <div class="candidates-grid">
                        ${candidateCardsHtml}
                    </div>
                </div>
            `;

            showModal('ğŸ“‹ æ¡ç”¨æ´»å‹•', html, true);
        }

        // ğŸ†• ç‰¹æ€§ã®è©³ç´°ã‚’è¡¨ç¤º
        function showTraitDetail(traitKey, fromHiring = false) {
            const trait = SUB_TRAITS[traitKey];
            if (!trait) return;

            const effectList = Object.entries(trait.impact || {})
                .map(([key, value]) => `<li>${key}: ${value > 0 ? '+' : ''}${value}%</li>`)
                .join('');

            // æ¡ç”¨ç”»é¢ã‹ã‚‰é–‹ã‹ã‚ŒãŸå ´åˆã¯ã€é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§æ¡ç”¨ç”»é¢ã«æˆ»ã‚‹
            const closeAction = (fromHiring || window.hireCandidates) ? 'closeDetailModal()' : 'closeModal()';

            const html = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">${trait.emoji}</div>
                    <h3 style="margin: 0 0 8px 0; color: ${trait.negative ? '#f44336' : '#4caf50'};">
                        ${trait.name}
                    </h3>
                    <div style="display: inline-block; padding: 4px 12px; background: ${trait.negative ? 'rgba(244, 67, 54, 0.1)' : 'rgba(76, 175, 80, 0.1)'}; border-radius: 12px; font-size: 11px; margin-bottom: 16px;">
                        ${trait.negative ? 'âš ï¸ ãƒã‚¬ãƒ†ã‚£ãƒ–' : 'âœ¨ ãƒã‚¸ãƒ†ã‚£ãƒ–'}
                    </div>
                    <div style="font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 12px;">
                        ${trait.effect}
                    </div>
                    ${effectList ? `
                        <div style="background: rgba(240, 240, 240, 0.5); padding: 12px; border-radius: 8px; margin-top: 12px; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">ğŸ“Š åŠ¹æœ:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                ${effectList}
                            </ul>
                        </div>
                    ` : ''}
                    <button class="btn-primary" onclick="${closeAction}" style="margin-top: 16px; width: 100%;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;

            showModal('', html, true);
        }

        // ğŸ†• æ€§æ ¼ã®è©³ç´°ã‚’è¡¨ç¤º
        function showPersonalityDetail(personalityKey, fromHiring = false) {
            const personality = PERSONALITIES[personalityKey];
            if (!personality) return;

            const effectList = Object.entries(personality.effects || {})
                .map(([key, value]) => {
                    const effectNames = {
                        developmentSpeed: 'é–‹ç™ºé€Ÿåº¦',
                        bugRate: 'ãƒã‚°ç™ºç”Ÿç‡',
                        teamEfficiency: 'ãƒãƒ¼ãƒ åŠ¹ç‡',
                        salesBonus: 'å–¶æ¥­ãƒœãƒ¼ãƒŠã‚¹',
                        planningBonus: 'ä¼ç”»ãƒœãƒ¼ãƒŠã‚¹',
                        managementBonus: 'ç®¡ç†ãƒœãƒ¼ãƒŠã‚¹',
                        learningSpeed: 'å­¦ç¿’é€Ÿåº¦',
                        creativity: 'å‰µé€ æ€§'
                    };
                    return `<li>${effectNames[key] || key}: ${value > 0 ? '+' : ''}${value}%</li>`;
                })
                .join('');

            const compatibleList = personality.compatible?.map(k => PERSONALITIES[k]?.name).filter(Boolean).join('ã€') || 'ãªã—';
            const incompatibleList = personality.incompatible?.map(k => PERSONALITIES[k]?.name).filter(Boolean).join('ã€') || 'ãªã—';

            // æ¡ç”¨ç”»é¢ã‹ã‚‰é–‹ã‹ã‚ŒãŸå ´åˆã¯ã€é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§æ¡ç”¨ç”»é¢ã«æˆ»ã‚‹
            const closeAction = (fromHiring || window.hireCandidates) ? 'closeDetailModal()' : 'closeModal()';

            const html = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">${personality.emoji}</div>
                    <h3 style="margin: 0 0 16px 0; color: #667eea;">
                        ${personality.name}
                    </h3>
                    <div style="font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 16px; text-align: left;">
                        ${personality.description}
                    </div>
                    ${effectList ? `
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">ğŸ“Š åŠ¹æœ:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                ${effectList}
                            </ul>
                        </div>
                    ` : ''}
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; text-align: left;">
                        <div style="font-weight: 600; font-size: 11px; color: #4caf50; margin-bottom: 4px;">âœ… ç›¸æ€§è‰¯ã„:</div>
                        <div style="font-size: 12px;">${compatibleList}</div>
                    </div>
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 16px; text-align: left;">
                        <div style="font-weight: 600; font-size: 11px; color: #f44336; margin-bottom: 4px;">âŒ ç›¸æ€§æ‚ªã„:</div>
                        <div style="font-size: 12px;">${incompatibleList}</div>
                    </div>
                    <button class="btn-primary" onclick="${closeAction}" style="width: 100%;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;

            showModal('', html, true);
        }

        // æ¡ç”¨å‡¦ç† (æ—§hireCurrentCandidate + hireEmployeeçµ±åˆ)
        function hireCurrentCandidate() {
            if (!window.currentCandidate) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            hireEmployee(window.currentCandidate);
        }

        function hireEmployee(candidate) {
            if (!requireCompanyActive()) return;
            if (game.money < candidate.salary * 3) {
                showModal('æ¡ç”¨å¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ3ãƒ¶æœˆåˆ†ã®çµ¦ä¸ãŒå¿…è¦ï¼‰');
                return;
            }
            game.money -= candidate.salary * 3;
            game.employees.push(candidate);
            if (characterScene) {
                const index = game.employees.length - 1;
                const cols = 5;
                const row = Math.floor(index / cols);
                const col = index % cols;
                const x = 100 + col * 150;
                const y = 100 + row * 150;
                characterScene.addCharacter(String(candidate.id), x, y);
            }

            // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            window.currentCandidate = null;

            updateDisplay();
            renderActivePanel();
            closeModal();
            showModal('ğŸ‰ æ¡ç”¨æˆåŠŸ', `${escapeHtml(candidate.name)}ã•ã‚“ã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼`);
        }

        // ğŸ¯ èƒ½åŠ›å€¤ã«å¿œã˜ãŸæˆé•·å€ç‡ã‚’è¨ˆç®— (é€“æ¸›å‹æˆé•·æ›²ç·š)
        function calculateGrowthMultiplier(currentAbility) {
            if (currentAbility >= 90) return 0.2;  // 90+: 20% (ã»ã¼æˆé•·ã—ãªã„)
            if (currentAbility >= 80) return 0.4;  // 80-89: 40% (ã‹ãªã‚ŠéˆåŒ–)
            if (currentAbility >= 70) return 0.6;  // 70-79: 60% (æˆé•·éˆåŒ–)
            return 1.0;  // 0-69: 100% (é€šå¸¸æˆé•·)
        }

        // ğŸ¢ éƒ¨ç½²ç•°å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDepartmentChangeModal(employee) {
            if (!requireCompanyActive()) return;

            const currentDept = DEPARTMENTS[employee.department];
            const departmentOptions = Object.keys(DEPARTMENTS).map(deptKey => {
                const dept = DEPARTMENTS[deptKey];
                const isCurrent = deptKey === employee.department;
                return `
                    <button onclick="changeDepartment(${employee.id}, '${deptKey}')"
                            class="dept-option ${isCurrent ? 'current' : ''}"
                            ${isCurrent ? 'disabled' : ''}>
                        <div class="dept-emoji">${dept.emoji}</div>
                        <div class="dept-name">${dept.name}</div>
                        <div class="dept-desc">${dept.description}</div>
                        ${isCurrent ? '<div class="current-badge">ç¾åœ¨ã®éƒ¨ç½²</div>' : ''}
                    </button>
                `;
            }).join('');

            const html = `
                <div style="margin: 16px 0;">
                    <p style="margin-bottom: 16px; color: #666;">
                        ${escapeHtml(employee.name)}ã®é…å±å…ˆã‚’å¤‰æ›´ã—ã¾ã™
                    </p>
                    <div class="dept-options-grid">
                        ${departmentOptions}
                    </div>
                </div>
            `;

            showModal('ğŸ¢ éƒ¨ç½²ç•°å‹•', html);
        }

        // ğŸ¢ éƒ¨ç½²ã‚’å¤‰æ›´
        function changeDepartment(employeeId, newDepartmentKey) {
            if (!requireCompanyActive()) return;

            const employee = game.employees.find(e => e.id === employeeId);
            if (!employee) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'å¾“æ¥­å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (employee.department === newDepartmentKey) {
                showModal('ç•°å‹•å¤±æ•—', 'ã™ã§ã«ãã®éƒ¨ç½²ã«æ‰€å±ã—ã¦ã„ã¾ã™');
                return;
            }

            const oldDept = DEPARTMENTS[employee.department];
            const newDept = DEPARTMENTS[newDepartmentKey];

            employee.department = newDepartmentKey;

            // æˆé•·å±¥æ­´ã«è¨˜éŒ²
            if (!employee.growthHistory) employee.growthHistory = [];
            employee.growthHistory.push({
                turn: game.turn,
                event: 'éƒ¨ç½²ç•°å‹•',
                description: `${oldDept.emoji} ${oldDept.name} ã‹ã‚‰ ${newDept.emoji} ${newDept.name} ã¸ç•°å‹•`
            });

            updateDisplay();
            renderActivePanel();

            closeModal();
            showModal('ğŸ‰ ç•°å‹•å®Œäº†', `${escapeHtml(employee.name)}ã‚’${newDept.emoji} ${newDept.name}ã«ç•°å‹•ã•ã›ã¾ã—ãŸï¼`);
        }

        // ğŸ‘” æ˜‡é€²å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canPromote(employee) {
            const positionOrder = ['staff', 'senior', 'manager', 'director'];
            const currentIndex = positionOrder.indexOf(employee.position);

            if (currentIndex === -1 || currentIndex >= positionOrder.length - 1) {
                return false; // æ—¢ã«æœ€é«˜ä½
            }

            const nextPositionKey = positionOrder[currentIndex + 1];
            const nextPosition = POSITIONS[nextPositionKey];

            // å…¨èƒ½åŠ›ã®å¹³å‡ã‚’ãƒã‚§ãƒƒã‚¯
            const avgAbility = (employee.abilities.technical + employee.abilities.sales +
                                employee.abilities.planning + employee.abilities.management) / 4;

            return avgAbility >= nextPosition.requiredAbility;
        }

        // ğŸ‘” æ˜‡é€²ã•ã›ã‚‹
        function promoteEmployee(employeeId) {
            if (!requireCompanyActive()) return;

            const employee = game.employees.find(e => e.id === employeeId);
            if (!employee) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'å¾“æ¥­å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!canPromote(employee)) {
                showModal('æ˜‡é€²ä¸å¯', 'æ˜‡é€²ã«å¿…è¦ãªèƒ½åŠ›å€¤ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            const positionOrder = ['staff', 'senior', 'manager', 'director'];
            const currentIndex = positionOrder.indexOf(employee.position);
            const nextPositionKey = positionOrder[currentIndex + 1];

            const oldPosition = POSITIONS[employee.position];
            const newPosition = POSITIONS[nextPositionKey];

            // å½¹è·ã‚’ä¸Šã’ã‚‹
            employee.position = nextPositionKey;

            // çµ¦ä¸ã‚’èª¿æ•´ (å½¹è·ã®çµ¦ä¸å€ç‡ã‚’é©ç”¨)
            const baseSalary = employee.salary / oldPosition.salaryMultiplier;
            employee.salary = Math.floor(baseSalary * newPosition.salaryMultiplier);

            // ğŸŒ³ æ˜‡é€²ãƒœãƒ¼ãƒŠã‚¹: ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ (å½¹è·ã«å¿œã˜ã¦)
            const promotionBonus = {
                senior: 3,
                manager: 5,
                director: 10
            };
            const bonusPoints = promotionBonus[nextPositionKey] || 0;
            employee.skillPoints = (employee.skillPoints || 0) + bonusPoints;

            // æˆé•·å±¥æ­´ã«è¨˜éŒ²
            if (!employee.growthHistory) employee.growthHistory = [];
            employee.growthHistory.push({
                turn: game.turn,
                event: 'æ˜‡é€²',
                description: `${oldPosition.emoji} ${oldPosition.name} ã‹ã‚‰ ${newPosition.emoji} ${newPosition.name} ã¸æ˜‡é€²ï¼ | ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ+${bonusPoints}`
            });

            updateDisplay();
            renderActivePanel();

            closeModal();

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const html = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 64px; margin-bottom: 16px;">ğŸ‰</div>
                    <h2 style="color: #667eea; margin-bottom: 12px;">æ˜‡é€²ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™!</h2>
                    <p style="font-size: 18px; margin-bottom: 8px;">${escapeHtml(employee.name)}</p>
                    <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                        ${oldPosition.emoji} ${oldPosition.name} â†’ ${newPosition.emoji} ${newPosition.name}
                    </p>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 12px; margin-top: 16px;">
                        <div>ğŸ’° æ–°ã—ã„çµ¦ä¸: ${Math.floor(employee.salary / 10000)}ä¸‡å††</div>
                        ${newPosition.canManage ? `<div style="margin-top: 8px;">ğŸ‘¥ ç®¡ç†å¯èƒ½äººæ•°: ${newPosition.canManage}å</div>` : ''}
                        ${bonusPoints > 0 ? `<div style="margin-top: 8px; color: #667eea; font-weight: 600;">ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ+${bonusPoints}ç²å¾—!</div>` : ''}
                    </div>
                </div>
            `;

            showModal('', html, true);
        }

        // ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼é–¢é€£é–¢æ•°ç¾¤

        // ã‚¹ã‚­ãƒ«ãŒç²å¾—å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canUnlockSkill(employee, category, skillId) {
            const skill = SKILL_TREE[category]?.skills[skillId];
            if (!skill) return false;

            // æ—¢ã«ç²å¾—æ¸ˆã¿
            if (employee.unlockedSkills.includes(skillId)) return false;

            // ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆä¸è¶³
            if (employee.skillPoints < skill.cost) return false;

            // å‰æã‚¹ã‚­ãƒ«æœªç²å¾—
            if (skill.prerequisites && skill.prerequisites.length > 0) {
                for (const prereq of skill.prerequisites) {
                    if (!employee.unlockedSkills.includes(prereq)) {
                        return false;
                    }
                }
            }

            return true;
        }

        // ã‚¹ã‚­ãƒ«ã‚’ç²å¾—
        function unlockSkill(employeeId, category, skillId) {
            if (!requireCompanyActive()) return;

            const employee = game.employees.find(e => e.id === employeeId);
            if (!employee) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'å¾“æ¥­å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const skill = SKILL_TREE[category]?.skills[skillId];
            if (!skill) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'ã‚¹ã‚­ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç²å¾—å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (!canUnlockSkill(employee, category, skillId)) {
                let reason = '';
                if (employee.unlockedSkills.includes(skillId)) {
                    reason = 'æ—¢ã«ç²å¾—æ¸ˆã¿ã§ã™';
                } else if (employee.skillPoints < skill.cost) {
                    reason = `ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ (å¿…è¦: ${skill.cost}, ç¾åœ¨: ${employee.skillPoints})`;
                } else {
                    reason = 'å‰æã‚¹ã‚­ãƒ«ã‚’å…ˆã«ç²å¾—ã—ã¦ãã ã•ã„';
                }
                showModal('ã‚¹ã‚­ãƒ«ç²å¾—ä¸å¯', reason);
                return;
            }

            // ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
            employee.skillPoints -= skill.cost;

            // ã‚¹ã‚­ãƒ«ç²å¾—
            employee.unlockedSkills.push(skillId);

            // èƒ½åŠ›å€¤ãƒœãƒ¼ãƒŠã‚¹é©ç”¨
            if (skill.effect) {
                Object.keys(skill.effect).forEach(abilityKey => {
                    if (employee.abilities[abilityKey] !== undefined) {
                        employee.abilities[abilityKey] = Math.min(100, employee.abilities[abilityKey] + skill.effect[abilityKey]);
                    }
                });
            }

            // æˆé•·å±¥æ­´ã«è¨˜éŒ²
            if (!employee.growthHistory) employee.growthHistory = [];
            const effectText = Object.entries(skill.effect || {})
                .map(([key, value]) => `${key}+${value}`)
                .join(', ');
            employee.growthHistory.push({
                turn: game.turn,
                event: 'ã‚¹ã‚­ãƒ«ç²å¾—',
                description: `${skill.icon} ${skill.name} ã‚’ç¿’å¾—ï¼ (${effectText})`
            });

            updateDisplay();
            renderActivePanel();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const specialEffect = skill.special ? SKILL_EFFECTS[skill.special] : null;
            const html = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 64px; margin-bottom: 16px;">${skill.icon}</div>
                    <h2 style="color: #667eea; margin-bottom: 12px;">ã‚¹ã‚­ãƒ«ç¿’å¾—!</h2>
                    <p style="font-size: 18px; margin-bottom: 8px;">${escapeHtml(employee.name)}</p>
                    <p style="font-size: 16px; font-weight: 600; color: #667eea; margin-bottom: 12px;">
                        ${skill.name}
                    </p>
                    <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                        ${skill.description}
                    </p>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 12px; margin-top: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“ˆ åŠ¹æœ</div>
                        ${Object.entries(skill.effect || {}).map(([key, value]) =>
                            `<div>${key}: +${value}</div>`
                        ).join('')}
                        ${specialEffect ? `<div style="margin-top: 8px; color: #f093fb; font-weight: 600;">âœ¨ ${specialEffect.description}</div>` : ''}
                    </div>
                    <div style="margin-top: 12px; font-size: 14px; color: #999;">
                        æ®‹ã‚Šã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ: ${employee.skillPoints}
                    </div>
                </div>
            `;

            showModal('', html, true);

            // ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼UIã‚’å†è¡¨ç¤º (ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸå¾Œ)
            setTimeout(() => {
                showSkillTreeModal(employee);
            }, 100);
        }

        // ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showSkillTreeModal(employee) {
            const categories = Object.keys(SKILL_TREE);

            // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã‚’ç”Ÿæˆ
            const tabsHtml = categories.map((catKey, index) => {
                const cat = SKILL_TREE[catKey];
                return `
                    <button
                        class="skill-tab ${index === 0 ? 'active' : ''}"
                        onclick="switchSkillCategory('${catKey}')"
                        data-category="${catKey}"
                        style="background: ${index === 0 ? cat.color : 'rgba(255,255,255,0.1)'};">
                        ${cat.emoji} ${cat.name}
                    </button>
                `;
            }).join('');

            // å„ã‚«ãƒ†ã‚´ãƒªã®ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const skillPanelsHtml = categories.map((catKey, index) => {
                const cat = SKILL_TREE[catKey];
                const skillsHtml = Object.keys(cat.skills).map(skillId => {
                    const skill = cat.skills[skillId];
                    const isUnlocked = employee.unlockedSkills.includes(skillId);
                    const canUnlock = canUnlockSkill(employee, catKey, skillId);
                    const isLocked = !isUnlocked && !canUnlock;

                    // å‰æã‚¹ã‚­ãƒ«è¡¨ç¤º
                    let prereqHtml = '';
                    if (skill.prerequisites && skill.prerequisites.length > 0) {
                        const prereqNames = skill.prerequisites.map(prereqId => {
                            const prereqCat = Object.keys(SKILL_TREE).find(ck => SKILL_TREE[ck].skills[prereqId]);
                            const prereqSkill = prereqCat ? SKILL_TREE[prereqCat].skills[prereqId] : null;
                            const prereqUnlocked = employee.unlockedSkills.includes(prereqId);
                            return prereqSkill ?
                                `<span style="color: ${prereqUnlocked ? '#4caf50' : '#f44336'};">${prereqSkill.icon} ${prereqSkill.name}</span>`
                                : prereqId;
                        }).join(', ');
                        prereqHtml = `
                            <div style="font-size: 11px; color: #999; margin-top: 8px;">
                                å‰æ: ${prereqNames}
                            </div>
                        `;
                    }

                    // ç‰¹æ®ŠåŠ¹æœè¡¨ç¤º
                    const specialEffect = skill.special ? SKILL_EFFECTS[skill.special] : null;
                    const specialHtml = specialEffect ?
                        `<div style="font-size: 11px; color: #f093fb; margin-top: 6px;">âœ¨ ${specialEffect.description}</div>`
                        : '';

                    return `
                        <div class="skill-card ${isUnlocked ? 'unlocked' : ''} ${isLocked ? 'locked' : ''} ${canUnlock ? 'can-unlock' : ''}"
                             onclick="${canUnlock ? `unlockSkill(${employee.id}, '${catKey}', '${skillId}')` : ''}"
                             style="cursor: ${canUnlock ? 'pointer' : 'default'}; opacity: ${isLocked ? '0.4' : '1'};">
                            <div style="font-size: 32px; margin-bottom: 8px;">${skill.icon}</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: ${isUnlocked ? '#4caf50' : (canUnlock ? cat.color : '#666')};">
                                ${skill.name}
                                ${isUnlocked ? ' âœ“' : ''}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                ${skill.description}
                            </div>
                            <div style="font-size: 12px; margin-bottom: 4px;">
                                ${Object.entries(skill.effect || {}).map(([key, value]) =>
                                    `<span style="color: ${cat.color};">${key}+${value}</span>`
                                ).join(' ')}
                            </div>
                            ${specialHtml}
                            ${prereqHtml}
                            <div style="margin-top: 8px; font-size: 12px; font-weight: 600; color: ${canUnlock ? cat.color : '#999'};">
                                ${isUnlocked ? 'ç¿’å¾—æ¸ˆã¿' : `ã‚³ã‚¹ãƒˆ: ${skill.cost}SP`}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="skill-panel ${index === 0 ? 'active' : ''}" data-category="${catKey}">
                        <div class="skill-grid">
                            ${skillsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <div style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #667eea;">ğŸŒ³ ${escapeHtml(employee.name)} ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</h3>
                        <div style="background: rgba(102, 126, 234, 0.15); padding: 8px 16px; border-radius: 20px; font-weight: 600; color: #667eea;">
                            ğŸ’ ${employee.skillPoints} SP
                        </div>
                    </div>

                    <div class="skill-tabs">
                        ${tabsHtml}
                    </div>

                    ${skillPanelsHtml}

                    <div style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; font-size: 13px; color: #666;">
                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ç ”ä¿®ã‚„æ˜‡é€²ã§ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã§ãã¾ã™ã€‚ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹ã¨èƒ½åŠ›å€¤ãŒã‚¢ãƒƒãƒ—ã—ã¾ã™ï¼
                    </div>
                </div>
            `;

            showModal('', html, true);
        }

        // ã‚¹ã‚­ãƒ«ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ
        function switchSkillCategory(category) {
            // ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.skill-tab').forEach(tab => {
                const isActive = tab.dataset.category === category;
                tab.classList.toggle('active', isActive);
                if (isActive) {
                    const color = SKILL_TREE[category]?.color || '#667eea';
                    tab.style.background = color;
                } else {
                    tab.style.background = 'rgba(255,255,255,0.1)';
                }
            });

            // ãƒ‘ãƒãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.skill-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.category === category);
            });
        }

        function trainEmployees() {
            if (!requireCompanyActive()) return;
            if (game.employees.length === 0) {
                showModal('ç ”ä¿®å¤±æ•—', 'å¾“æ¥­å“¡ãŒã„ã¾ã›ã‚“');
                return;
            }
            const cost = 300000 * game.employees.length;
            if (game.money < cost) {
                showModal('ç ”ä¿®å¤±æ•—', `è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆå¿…è¦: ${cost / 10000}ä¸‡å††ï¼‰`);
                return;
            }

            // ğŸ†• ç ”ä¿®æ–¹å‘æ€§é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modalHtml = `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            ç ”ä¿®ã®æ–¹å‘æ€§ã‚’é¸æŠã—ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            ğŸ’° è²»ç”¨: ${cost / 10000}ä¸‡å†† | ğŸ‘¥ å¯¾è±¡: ${game.employees.length}å
                        </div>
                    </div>

                    <div style="display: grid; gap: 12px;">
                        <button class="btn-primary" onclick="executeTraining('balanced')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">âš–ï¸</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ãƒãƒ©ãƒ³ã‚¹å‹ç ”ä¿®</div>
                                <div style="font-size: 11px; opacity: 0.8;">å…¨èƒ½åŠ›ã‚’ã¾ã‚“ã¹ã‚“ãªãå‘ä¸Šï¼ˆåŸºæœ¬+10ï¼‰</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeTraining('technical')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #667eea, #764ba2);">
                            <span style="font-size: 24px;">âš™ï¸</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">æŠ€è¡“åŠ›ç‰¹åŒ–ç ”ä¿®</div>
                                <div style="font-size: 11px; opacity: 0.8;">æŠ€è¡“åŠ›+15ã€ãã®ä»–+5</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeTraining('sales')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <span style="font-size: 24px;">ğŸ’¼</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">å–¶æ¥­åŠ›ç‰¹åŒ–ç ”ä¿®</div>
                                <div style="font-size: 11px; opacity: 0.8;">å–¶æ¥­åŠ›+15ã€ãã®ä»–+5</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeTraining('planning')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <span style="font-size: 24px;">ğŸ“‹</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ä¼ç”»åŠ›ç‰¹åŒ–ç ”ä¿®</div>
                                <div style="font-size: 11px; opacity: 0.8;">ä¼ç”»åŠ›+15ã€ãã®ä»–+5</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeTraining('management')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #43e97b, #38f9d7);">
                            <span style="font-size: 24px;">ğŸ‘”</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ç®¡ç†åŠ›ç‰¹åŒ–ç ”ä¿®</div>
                                <div style="font-size: 11px; opacity: 0.8;">ç®¡ç†åŠ›+15ã€ãã®ä»–+5</div>
                            </div>
                        </button>

                        <button class="btn-secondary" onclick="closeModal()"
                                style="padding: 12px; margin-top: 8px;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            `;

            showModal('ğŸ“š ç ”ä¿®ãƒ—ãƒ­ã‚°ãƒ©ãƒ é¸æŠ', modalHtml, true);
        }

        // ğŸ†• å®Ÿéš›ã®ç ”ä¿®ã‚’å®Ÿè¡Œ
        function executeTraining(focusType) {
            closeModal();

            const cost = 300000 * game.employees.length;
            game.money -= cost;

            let bonusMessages = [];
            let growthDetails = []; // å„å¾“æ¥­å“¡ã®æˆé•·è©³ç´°ã‚’è¨˜éŒ²

            game.employees.forEach(emp => {
                let baseIncrease = 10;

                // Phase 2: fast_learnerç‰¹æ€§ã§ç ”ä¿®åŠ¹æœ+50%
                if (emp.subTraits && emp.subTraits.includes('fast_learner')) {
                    baseIncrease = Math.floor(baseIncrease * 1.5);
                    bonusMessages.push(`${emp.name}ã¯æ—©ç¿’å¾—ã§åŠ¹æœã‚¢ãƒƒãƒ—ï¼`);
                }

                // Phase 1: researcheræ€§æ ¼ã§å­¦ç¿’é€Ÿåº¦+30%
                if (emp.personalityKey === 'researcher') {
                    baseIncrease = Math.floor(baseIncrease * 1.3);
                    bonusMessages.push(`${emp.name}ã¯ç ”ç©¶è€…æ°—è³ªã§åŠ¹æœã‚¢ãƒƒãƒ—ï¼`);
                }

                // ğŸ†• ç ”ä¿®æ–¹å‘æ€§ã«å¿œã˜ãŸæˆé•·é‡ã‚’è¨­å®š
                const focusMap = {
                    'balanced': { technical: 1.0, sales: 1.0, planning: 1.0, management: 1.0 },
                    'technical': { technical: 1.5, sales: 0.5, planning: 0.5, management: 0.5 },
                    'sales': { technical: 0.5, sales: 1.5, planning: 0.5, management: 0.5 },
                    'planning': { technical: 0.5, sales: 0.5, planning: 1.5, management: 0.5 },
                    'management': { technical: 0.5, sales: 0.5, planning: 0.5, management: 1.5 }
                };

                const focusMultipliers = focusMap[focusType] || focusMap['balanced'];

                // ğŸ†• èƒ½åŠ›åˆ¥ã«é€“æ¸›æˆé•·ã‚’é©ç”¨
                let totalGrowth = 0;
                Object.keys(emp.abilities).forEach(key => {
                    const currentAbility = emp.abilities[key];
                    const growthMultiplier = calculateGrowthMultiplier(currentAbility);
                    const focusMultiplier = focusMultipliers[key] || 1.0;
                    const actualIncrease = Math.max(1, Math.floor(baseIncrease * growthMultiplier * focusMultiplier));

                    emp.abilities[key] = Math.min(100, currentAbility + actualIncrease);
                    totalGrowth += actualIncrease;
                });

                const avgGrowth = Math.floor(totalGrowth / 4);

                // ğŸŒ³ ç ”ä¿®ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆç²å¾— (æˆé•·é‡ã«å¿œã˜ã¦ä»˜ä¸)
                const earnedPoints = Math.max(1, Math.floor(avgGrowth / 3));  // å¹³å‡æˆé•·3ã”ã¨ã«1ãƒã‚¤ãƒ³ãƒˆ
                emp.skillPoints = (emp.skillPoints || 0) + earnedPoints;

                // æˆé•·å±¥æ­´ã«è¨˜éŒ²
                const focusNames = {
                    'balanced': 'ãƒãƒ©ãƒ³ã‚¹å‹',
                    'technical': 'æŠ€è¡“åŠ›ç‰¹åŒ–',
                    'sales': 'å–¶æ¥­åŠ›ç‰¹åŒ–',
                    'planning': 'ä¼ç”»åŠ›ç‰¹åŒ–',
                    'management': 'ç®¡ç†åŠ›ç‰¹åŒ–'
                };
                if (!emp.growthHistory) emp.growthHistory = [];
                emp.growthHistory.push({
                    turn: game.turn,
                    event: `ç ”ä¿®ï¼ˆ${focusNames[focusType] || 'ãƒãƒ©ãƒ³ã‚¹å‹'}ï¼‰`,
                    description: `ç ”ä¿®ã‚’å—ã‘ã¦å¹³å‡+${avgGrowth}ä¸Šæ˜‡ | ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ+${earnedPoints}`
                });

                // ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆç²å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                if (earnedPoints > 0) {
                    bonusMessages.push(`${emp.name}ã¯ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ+${earnedPoints}ã‚’ç²å¾—ï¼`);
                }

                growthDetails.push({name: emp.name, growth: avgGrowth});
            });

            updateDisplay();
            renderActivePanel();

            // ğŸ†• æˆé•·è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
            const focusNames = {
                'balanced': 'ãƒãƒ©ãƒ³ã‚¹å‹',
                'technical': 'æŠ€è¡“åŠ›ç‰¹åŒ–',
                'sales': 'å–¶æ¥­åŠ›ç‰¹åŒ–',
                'planning': 'ä¼ç”»åŠ›ç‰¹åŒ–',
                'management': 'ç®¡ç†åŠ›ç‰¹åŒ–'
            };
            let message = `ğŸ“š ${focusNames[focusType] || 'ãƒãƒ©ãƒ³ã‚¹å‹'}ç ”ä¿®ã‚’å®Ÿæ–½ã—ã¾ã—ãŸï¼<br><br>`;
            message += '<div style="font-size: 13px; line-height: 1.6;">';
            growthDetails.forEach(detail => {
                message += `<div>âœ¨ ${escapeHtml(detail.name)}: å¹³å‡ +${detail.growth}</div>`;
            });
            message += '</div>';

            if (bonusMessages.length > 0) {
                message += '<br><strong>ğŸŒŸ ãƒœãƒ¼ãƒŠã‚¹åŠ¹æœ:</strong><br>' + bonusMessages.join('<br>');
            }

            message += '<br><br><small style="color: #666;">ğŸ’¡ é«˜èƒ½åŠ›è€…ã¯æˆé•·ãŒéˆåŒ–ã—ã¾ã™ (70+: 60%, 80+: 40%, 90+: 20%)</small>';

            showModal('ğŸ“š ç ”ä¿®å®Œäº†', message);
        }

        function developProduct() {
            if (!requireCompanyActive()) return;
            if (game.employees.length < 2) {
                showModal('é–‹ç™ºå¤±æ•—', 'æœ€ä½2åã®å¾“æ¥­å“¡ãŒå¿…è¦ã§ã™');
                return;
            }
            if (game.money < 2000000) {
                showModal('é–‹ç™ºå¤±æ•—', 'è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ200ä¸‡å††å¿…è¦ï¼‰');
                return;
            }
            game.money -= 2000000;

            // Phase 1 & 2: ãƒãƒ¼ãƒ ç›¸æ€§ã¨ç‰¹æ€§ãƒ»æ€§æ ¼ã‚’è€ƒæ…®ã—ãŸå“è³ªè¨ˆç®—
            const teamCompatibility = calculateTeamCompatibility(game.employees);
            const avgTech = game.employees.reduce((sum, emp) => sum + emp.abilities.technical, 0) / game.employees.length;

            let qualityMultiplier = 1.0;
            let bonusMessages = [];

            // Phase 1: å®Œç’§ä¸»ç¾©è€…ã§å“è³ª+20%
            const perfectionists = game.employees.filter(emp => emp.personalityKey === 'perfectionist');
            if (perfectionists.length > 0) {
                qualityMultiplier *= 1.2;
                bonusMessages.push(`å®Œç’§ä¸»ç¾©è€…ãŒã„ã¦å“è³ªã‚¢ãƒƒãƒ—ï¼`);
            }

            // Phase 1: å­¤é«˜ã®å¤©æ‰ã§èƒ½åŠ›+40%
            const geniuses = game.employees.filter(emp => emp.personalityKey === 'lone_genius');
            if (geniuses.length > 0) {
                qualityMultiplier *= 1.4;
                bonusMessages.push(`å­¤é«˜ã®å¤©æ‰ã®åŠ›ã§å¤§å¹…å“è³ªã‚¢ãƒƒãƒ—ï¼`);
            }

            // Phase 2: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆç‰¹æ€§
            const architects = game.employees.filter(emp => emp.subTraits && emp.subTraits.includes('architect'));
            if (architects.length > 0) {
                qualityMultiplier *= 1.5;
                bonusMessages.push(`ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã®è¨­è¨ˆåŠ›ã§å“è³ªå‘ä¸Šï¼`);
            }

            // ãƒãƒ¼ãƒ ç›¸æ€§ã‚’å“è³ªã«åæ˜ 
            qualityMultiplier *= teamCompatibility;

            const baseQuality = Math.floor(50 + (avgTech / 2) + Math.random() * 20);
            const quality = Math.min(100, Math.floor(baseQuality * qualityMultiplier));

            const product = {
                id: Date.now(),
                name: `è£½å“${game.products.length + 1}`,
                quality: quality,
                sales: 0
            };
            game.products.push(product);
            updateDisplay();
            renderActivePanel();

            let message = `${product.name}ã‚’é–‹ç™ºã—ã¾ã—ãŸï¼<br>å“è³ª: ${quality}%`;
            if (bonusMessages.length > 0) {
                message += '<br><br><strong>ãƒœãƒ¼ãƒŠã‚¹åŠ¹æœ:</strong><br>' + bonusMessages.join('<br>');
            }
            if (teamCompatibility !== 1.0) {
                message += `<br>ãƒãƒ¼ãƒ ç›¸æ€§: ${(teamCompatibility * 100).toFixed(0)}%`;
            }
            showModal('ğŸ”§ é–‹ç™ºæˆåŠŸ', message);
        }

        function doMarketing() {
            if (!requireCompanyActive()) return;
            const cost = 1000000;
            if (game.money < cost) {
                showModal('å®Ÿæ–½å¤±æ•—', `è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆ${cost / 10000}ä¸‡å††å¿…è¦ï¼‰`);
                return;
            }

            // ğŸ†• ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modalHtml = `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã‚’é¸æŠã—ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            ğŸ’° è²»ç”¨: ${cost / 10000}ä¸‡å††
                        </div>
                    </div>

                    <div style="display: grid; gap: 12px;">
                        <button class="btn-primary" onclick="executeMarketing('balanced')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">âš–ï¸</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ãƒãƒ©ãƒ³ã‚¹å‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</div>
                                <div style="font-size: 11px; opacity: 0.8;">ã‚·ã‚§ã‚¢+0.3%ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›+1.0</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeMarketing('brand')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #667eea, #764ba2);">
                            <span style="font-size: 24px;">ğŸŒŸ</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ãƒ–ãƒ©ãƒ³ãƒ‰é‡è¦–</div>
                                <div style="font-size: 11px; opacity: 0.8;">ã‚·ã‚§ã‚¢+0.2%ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›+2.0</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeMarketing('share')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <span style="font-size: 24px;">ğŸ“ˆ</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ã‚·ã‚§ã‚¢æ‹¡å¤§é‡è¦–</div>
                                <div style="font-size: 11px; opacity: 0.8;">ã‚·ã‚§ã‚¢+0.5%ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›+0.5</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeMarketing('niche')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <span style="font-size: 24px;">ğŸ¯</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ãƒ‹ãƒƒãƒæˆ¦ç•¥</div>
                                <div style="font-size: 11px; opacity: 0.8;">ã‚·ã‚§ã‚¢+0.1%ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›+1.5</div>
                            </div>
                        </button>

                        <button class="btn-primary" onclick="executeMarketing('lowprice')"
                                style="padding: 15px; text-align: left; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #43e97b, #38f9d7);">
                            <span style="font-size: 24px;">ğŸ’°</span>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">ä½ä¾¡æ ¼æˆ¦ç•¥</div>
                                <div style="font-size: 11px; opacity: 0.8;">ã‚·ã‚§ã‚¢+0.6%ã€ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›-0.3</div>
                            </div>
                        </button>

                        <button class="btn-secondary" onclick="closeModal()"
                                style="padding: 12px; margin-top: 8px;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            `;

            showModal('ğŸ“¢ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥é¸æŠ', modalHtml, true);
        }

        // ğŸ†• å®Ÿéš›ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚’å®Ÿè¡Œ
        function executeMarketing(strategy) {
            closeModal();

            const cost = 1000000;
            game.money -= cost;

            const strategies = {
                'balanced': { share: 0.3, brand: 1.0, name: 'ãƒãƒ©ãƒ³ã‚¹å‹' },
                'brand': { share: 0.2, brand: 2.0, name: 'ãƒ–ãƒ©ãƒ³ãƒ‰é‡è¦–' },
                'share': { share: 0.5, brand: 0.5, name: 'ã‚·ã‚§ã‚¢æ‹¡å¤§é‡è¦–' },
                'niche': { share: 0.1, brand: 1.5, name: 'ãƒ‹ãƒƒãƒæˆ¦ç•¥' },
                'lowprice': { share: 0.6, brand: -0.3, name: 'ä½ä¾¡æ ¼æˆ¦ç•¥' }
            };

            const selected = strategies[strategy] || strategies['balanced'];

            game.marketShare = Math.min(15, game.marketShare + selected.share);
            game.brandPower = Math.max(0, Math.min(5, game.brandPower + selected.brand));

            updateDisplay();
            renderActivePanel();
            updateRanking();

            let message = `ğŸ“¢ ${selected.name}ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’å®Ÿæ–½ã—ã¾ã—ãŸï¼<br><br>`;
            message += `ğŸ“Š å¸‚å ´ã‚·ã‚§ã‚¢: +${selected.share}% â†’ ${game.marketShare.toFixed(2)}%<br>`;
            message += `âœ¨ ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›: ${selected.brand >= 0 ? '+' : ''}${selected.brand} â†’ ${game.brandPower.toFixed(1)}`;

            showModal('ğŸ“¢ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å®Œäº†', message);
        }

        function getLoan() {
            if (!requireCompanyActive()) return;
            game.money += LOAN_AMOUNT;
            game.debt += LOAN_AMOUNT;
            updateDisplay();
            renderActivePanel();
            showModal('ğŸ¦ èè³‡å®Ÿè¡Œ', `500ä¸‡å††ã®èè³‡ã‚’å—ã‘ã¾ã—ãŸ<br>åˆ©ç‡: ${(LOAN_INTEREST_RATE * 100).toFixed(1)}%/æœˆ`);
        }

        function repayLoan() {
            if (!requireCompanyActive()) return;
            if (game.debt <= 0) {
                showModal('è¿”æ¸ˆä¸è¦', 'ç¾åœ¨ã®å€Ÿå…¥ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            const maxRepay = Math.min(game.debt, game.money);
            if (maxRepay <= 0) {
                showModal('è¿”æ¸ˆå¤±æ•—', 'è¿”æ¸ˆã«å……ã¦ã‚‹è³‡é‡‘ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            game.money -= maxRepay;
            game.debt -= maxRepay;
            updateDisplay();
            renderActivePanel();
            showModal('ğŸ’¸ è¿”æ¸ˆå®Œäº†', `${Math.floor(maxRepay / 10000)}ä¸‡å††ã‚’è¿”æ¸ˆã—ã¾ã—ãŸ`);
        }

        function nextTurn() {
            if (!requireCompanyActive()) return;
            game.turn++;
            syncEmployeeAnimations();
            game.week++;

            // Phase 2: éš ã‚Œç‰¹æ€§ã®ç™ºå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆé€±æ¬¡ï¼‰
            let hiddenTraitMessages = [];
            game.employees.forEach(emp => {
                if (emp.hiddenTraitRevealed) return;
                if (!emp.joinedTurn) emp.joinedTurn = 1;

                const turnsSinceJoined = game.turn - emp.joinedTurn;
                const hiddenTrait = HIDDEN_TRAITS[emp.hiddenTrait];

                if (!hiddenTrait) return;

                if (turnsSinceJoined >= hiddenTrait.revealTurn) {
                    emp.hiddenTraitRevealed = true;
                    hiddenTraitMessages.push({
                        name: emp.name,
                        trait: hiddenTrait
                    });

                    // éš ã‚Œç‰¹æ€§ã®åŠ¹æœã‚’é©ç”¨
                    if (emp.hiddenTrait === 'latent_leader') {
                        emp.abilities.management = Math.min(100, emp.abilities.management + 30);
                    } else if (emp.hiddenTrait === 'late_bloomer') {
                        Object.keys(emp.abilities).forEach(key => {
                            emp.abilities[key] = Math.min(100, Math.floor(emp.abilities[key] * 1.5));
                        });
                    } else if (emp.hiddenTrait === 'self_taught') {
                        Object.keys(emp.abilities).forEach(key => {
                            emp.abilities[key] = Math.min(100, emp.abilities[key] + 15);
                        });
                    }

                    // æˆé•·å±¥æ­´ã«è¨˜éŒ²
                    if (!emp.growthHistory) emp.growthHistory = [];
                    emp.growthHistory.push({
                        turn: game.turn,
                        event: 'éš ã‚Œç‰¹æ€§åˆ¤æ˜',
                        description: `${hiddenTrait.emoji} ${hiddenTrait.name}ãŒåˆ¤æ˜ - ${hiddenTrait.effect}`
                    });
                }
            });

            if (game.week > 4) {
                game.week = 1;
                game.month++;
                if (game.month > 12) {
                    game.month = 1;
                    game.year++;
                }

                // Phase 2: self_taughtç‰¹æ€§ã§æ¯æœˆè‡ªå‹•ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—
                game.employees.forEach(emp => {
                    if (emp.hiddenTraitRevealed && emp.hiddenTrait === 'self_taught') {
                        const randomAbility = ['technical', 'sales', 'planning', 'management'][Math.floor(Math.random() * 4)];
                        emp.abilities[randomAbility] = Math.min(100, emp.abilities[randomAbility] + 5);
                    }
                });

                let revenue = 0;
                game.products.forEach(product => {
                    // Phase 1: ã‚«ãƒªã‚¹ãƒæ€§æ ¼ã§å£²ä¸Š+25%
                    let salesMultiplier = 1.0;
                    const charismaticCount = game.employees.filter(emp => emp.personalityKey === 'charismatic').length;
                    if (charismaticCount > 0) {
                        salesMultiplier *= (1 + charismaticCount * 0.25);
                    }

                    const productRevenue = Math.floor(product.quality * 10000 * salesMultiplier);
                    product.sales += productRevenue;
                    revenue += productRevenue;
                });

                const salaryTotal = game.employees.reduce((sum, emp) => sum + emp.salary, 0);
                const interest = game.debt > 0 ? Math.floor(game.debt * LOAN_INTEREST_RATE) : 0;
                game.monthlyRevenue = revenue;
                game.revenueHistory.push(revenue);
                const profit = revenue - salaryTotal - interest;
                game.money += profit;

                if (game.money < 0) {
                    game.isBankrupt = true;
                    updateDisplay();
                    renderActivePanel();
                    updateRanking();
                    showModal('ğŸ’” ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼', 'è³‡é‡‘ä¸è¶³ã§å€’ç”£ã—ã¾ã—ãŸ...<br>å†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const summaryLines = [
                    `ğŸ“Š å£²ä¸Š: ${Math.floor(revenue / 10000)}ä¸‡å††`,
                    `ğŸ‘¥ äººä»¶è²»: ${Math.floor(salaryTotal / 10000)}ä¸‡å††`
                ];
                if (interest > 0) {
                    summaryLines.push(`ğŸ“ˆ åˆ©æ¯: ${Math.floor(interest / 10000)}ä¸‡å††`);
                }
                const profitColor = profit >= 0 ? '#4caf50' : '#f44336';
                summaryLines.push(`<div style="margin-top: 8px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    ğŸ’° æœ€çµ‚åˆ©ç›Š: <strong style="color: ${profitColor}">${Math.floor(profit / 10000)}ä¸‡å††</strong>
                </div>`);
                showModal('ğŸ“… æœˆæ¬¡æ±ºç®—', summaryLines.join('<br>'));
                updateCompetitors();
                generateNews();
            }

            // Phase 2: éš ã‚Œç‰¹æ€§ãŒåˆ¤æ˜ã—ãŸå ´åˆã€é€šçŸ¥ã‚’è¡¨ç¤º
            if (hiddenTraitMessages.length > 0) {
                setTimeout(() => {
                    const messages = hiddenTraitMessages.map(msg => {
                        return `<div style="margin: 12px 0; padding: 12px; background: linear-gradient(135deg, #ffd700, #ffed4e); border-radius: 12px;">
                            <strong>${msg.name}</strong>ã®éš ã‚ŒãŸæ‰èƒ½ãŒé–‹èŠ±ï¼<br>
                            <span style="font-size: 18px;">${msg.trait.emoji} ${msg.trait.name}</span><br>
                            <span style="font-size: 13px; color: #666;">${msg.trait.effect}</span>
                        </div>`;
                    }).join('');
                    showModal('âœ¨ éš ã‚ŒãŸç‰¹æ€§ãŒåˆ¤æ˜ï¼', messages);
                    renderActivePanel();
                }, 500);
            }

            // ã‚ªãƒ•ã‚£ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            checkOfficeUpgrade();

            updateDisplay();
            renderActivePanel();
            updateRanking();
        }

        async function saveGame() {
            if (!requireCompanyActive()) return;
            try {
                // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                const saveData = Object.assign({}, game, { activePanel });

                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const metadata: SaveMetadata = {
                    slotId: currentSlotId,
                    companyName: game.companyName || 'æ ªå¼ä¼šç¤¾ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—',
                    playTime: game.turn * 60, // ä»®: ã‚¿ãƒ¼ãƒ³æ•°ã‹ã‚‰æ¦‚ç®—ï¼ˆ1ã‚¿ãƒ¼ãƒ³=1åˆ†ã¨ä»®å®šï¼‰
                    lastSaveDate: new Date().toISOString(),
                    gameDate: {
                        year: game.year || 2025,
                        month: game.month || 1,
                        week: game.week || 1
                    },
                    money: game.money,
                    employeeCount: game.employees.length,
                    marketShare: parseFloat((game.marketShare || 0.1).toFixed(2)),
                    brandLevel: Math.floor((game.brandPower || 1) / 20) // ãƒ–ãƒ©ãƒ³ãƒ‰å€¤ã‚’æ˜Ÿã®æ•°ã«å¤‰æ›ï¼ˆ20ã”ã¨ã«1ã¤æ˜Ÿï¼‰
                };

                // ã‚¹ãƒ­ãƒƒãƒˆã«ä¿å­˜
                await saveSlotData(currentSlotId, saveData, metadata);

                showModal('ğŸ’¾ ä¿å­˜å®Œäº†', `ã‚¹ãƒ­ãƒƒãƒˆ ${currentSlotId} ã«ä¿å­˜ã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('Failed to save game', error);
                showModal('ä¿å­˜å¤±æ•—', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function restartGame() {
            closeModal();
            resetGameState();
            addInitialEmployee();
            updateDisplay();
            renderEmployees();
            renderProducts();
            renderMarket();
            renderFinance();
            updateRanking();
            initCharts();
            showPanel(null, 'overview');
            generateNews();
            await storageHelpers.removeItem(SAVE_KEY);
            showModal('ğŸ”„ å†ã‚¹ã‚¿ãƒ¼ãƒˆ', 'æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }

        function showModal(title, body, isHtml = false) {
            document.getElementById('modalTitle').textContent = title;
            // isHtmlãŒtrueã®å ´åˆã¯æ”¹è¡Œç½®æ›ã‚’ã‚¹ã‚­ãƒƒãƒ—
            document.getElementById('modalBody').innerHTML = isHtml ? body : body.replace(/\n/g, '<br>');
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            const modalEl = document.getElementById('modal');
            modalEl.classList.remove('active', 'employee-detail-modal');

            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„
            if (employeeRadarChart) {
                employeeRadarChart.destroy();
                employeeRadarChart = null;
            }
        }

        // å¾“æ¥­å“¡è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
        let employeeRadarChart = null;

        function showEmployeeDetail(employee) {
            const personality = PERSONALITIES[employee.personalityKey] || PERSONALITIES.logical;

            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
            let headerHtml = `
                <div class="employee-detail-header">
                    <div class="employee-detail-icon">${personality.emoji}</div>
                    <div class="employee-detail-info">
                        <div class="employee-detail-name">${escapeHtml(employee.name)}</div>
                        <div class="employee-detail-meta">
                            ${personality.name} | ğŸ’° æœˆçµ¦ ${Math.floor(employee.salary / 10000)}ä¸‡å††
                        </div>
                    </div>
                </div>
            `;

            // ğŸ†• æ€§æ ¼ã®åŠ¹æœèª¬æ˜
            const personalityEffectsHtml = `
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #667eea; cursor: pointer; text-decoration: underline; text-decoration-style: dotted;"
                         onclick="showPersonalityDetail('${employee.personalityKey}')"
                         title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º">
                        ${personality.emoji} ${personality.name}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                        ${Object.entries(personality.effects || {}).map(([key, value]) => {
                            const effectName = {
                                developmentSpeed: 'é–‹ç™ºé€Ÿåº¦',
                                bugRate: 'ãƒã‚°ç™ºç”Ÿç‡',
                                teamEfficiency: 'ãƒãƒ¼ãƒ åŠ¹ç‡',
                                salesBonus: 'å–¶æ¥­ãƒœãƒ¼ãƒŠã‚¹',
                                planningBonus: 'ä¼ç”»ãƒœãƒ¼ãƒŠã‚¹',
                                managementBonus: 'ç®¡ç†ãƒœãƒ¼ãƒŠã‚¹',
                                learningSpeed: 'å­¦ç¿’é€Ÿåº¦',
                                creativity: 'å‰µé€ æ€§',
                                motivation: 'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³'
                            }[key] || key;
                            const isNegative = (key === 'bugRate' && value > 1) || value < 1;
                            const displayValue = value > 1 ? `+${Math.round((value - 1) * 100)}%` : `${Math.round((1 - value) * 100)}%æ¸›`;
                            return `<div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                <span>ğŸ“Š ${effectName}</span>
                                <span style="font-weight: 600; color: ${isNegative ? '#f44336' : '#4caf50'};">${displayValue}</span>
                            </div>`;
                        }).join('')}
                    </div>
                    ${personality.compatible ? `
                        <div style="font-size: 12px; color: #4caf50; margin-top: 8px;">
                            âœ… ç›¸æ€§è‰¯å¥½: ${personality.compatible.map(k => PERSONALITIES[k]?.name || k).join(', ')}
                        </div>
                    ` : ''}
                    ${personality.incompatible ? `
                        <div style="font-size: 12px; color: #f44336; margin-top: 4px;">
                            âŒ ç›¸æ€§æ‚ªã„: ${personality.incompatible.map(k => PERSONALITIES[k]?.name || k).join(', ')}
                        </div>
                    ` : ''}
                </div>
            `;

            // === ğŸ†• è³‡æ ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
            let qualificationSectionHtml = '';
            if (employee.qualification && typeof QUALIFICATIONS_30 !== 'undefined') {
                const qual = QUALIFICATIONS_30[employee.qualification];
                if (qual) {
                    const qualBadge = typeof renderQualificationBadge === 'function' ?
                        renderQualificationBadge(employee.qualification) : '';
                    const qualDetails = typeof renderQualificationDetails === 'function' ?
                        renderQualificationDetails(employee.qualification) : '';

                    qualificationSectionHtml = `
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 215, 0, 0.05); border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.3);">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #FFD700;">ğŸ“ ä¿æœ‰è³‡æ ¼</div>
                            ${qualBadge}
                            ${qualDetails}
                        </div>
                    `;
                }
            }

            // ç‰¹æ€§è¡¨ç¤º (åŠ¹æœèª¬æ˜ä»˜ã)
            let traitsHtml = '';
            if (employee.subTraits && employee.subTraits.length > 0) {
                traitsHtml = `
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">
                            ğŸŒŸ ç‰¹æ€§
                            <span style="font-size: 10px; color: #999; font-weight: normal;">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ï¼‰</span>
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${employee.subTraits.map(traitKey => {
                                const trait = SUB_TRAITS[traitKey];
                                if (!trait) return '';
                                return `
                                    <div style="padding: 10px; background: ${trait.negative ? 'rgba(244, 67, 54, 0.05)' : 'rgba(76, 175, 80, 0.05)'}; border-radius: 8px; border-left: 3px solid ${trait.negative ? '#f44336' : '#4caf50'}; cursor: pointer; transition: transform 0.2s;"
                                         onclick="showTraitDetail('${traitKey}')"
                                         onmouseover="this.style.transform='scale(1.02)'"
                                         onmouseout="this.style.transform='scale(1)'"
                                         title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º">
                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                            <span class="trait-badge ${trait.negative ? 'negative' : 'positive'}" style="margin: 0;">
                                                ${trait.emoji} ${trait.name}
                                            </span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                            ${trait.effect}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (employee.hiddenTraitRevealed) {
                const hiddenTrait = HIDDEN_TRAITS[employee.hiddenTrait];
                traitsHtml += `
                    <div style="margin-bottom: 16px;">
                        <span class="trait-badge hidden">
                            âœ¨ ${hiddenTrait.emoji} ${hiddenTrait.name}
                        </span>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            ${hiddenTrait.effect}
                        </div>
                    </div>
                `;
            }

            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ
            const radarHtml = `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">ğŸ“Š èƒ½åŠ›å€¤</div>
                    <div class="radar-chart-container">
                        <canvas id="employeeRadarChart"></canvas>
                    </div>
                </div>
            `;

            // ğŸ­ æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆPhase 2.5è¿½åŠ ï¼‰
            const temperamentHtml = employee.temperament ? `
                <div style="margin-bottom: 16px; padding: 16px; background: rgba(255, 215, 0, 0.05); border-radius: 12px; border: 1px solid rgba(255, 215, 0, 0.2);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #f59e0b;">ğŸ­ æ°—è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 13px;">
                        ${Object.keys(TEMPERAMENT_TRAITS).map(key => {
                            const trait = TEMPERAMENT_TRAITS[key];
                            const value = employee.temperament[key] || 50;
                            const percentage = Math.min(100, Math.max(0, value));
                            const barColor = percentage >= 70 ? '#10b981' : percentage >= 40 ? '#f59e0b' : '#ef4444';
                            const isStrong = percentage >= 70;
                            return `
                                <div style="margin-bottom: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="font-weight: 500;">${trait.emoji} ${trait.name}</span>
                                        <span style="font-weight: 600; color: ${barColor};">${percentage}${isStrong ? ' â­' : ''}</span>
                                    </div>
                                    <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 12px; text-align: center;">
                        ğŸ’¡ 70ä»¥ä¸Šã§å¼·ã¿ã€40æœªæº€ã§å¼±ã¿ã¨ã—ã¦å½±éŸ¿
                    </div>
                </div>
            ` : '';

            // ğŸ†• éƒ¨ç½²ãƒ»å½¹è·æƒ…å ±ã¨æ“ä½œãƒœã‚¿ãƒ³
            const dept = DEPARTMENTS[employee.department];
            const position = POSITIONS[employee.position];
            const canPromoteNow = canPromote(employee);

            const deptPositionHtml = `
                <div style="margin-bottom: 16px; padding: 16px; background: rgba(102, 126, 234, 0.05); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #667eea;">ğŸ’¼ æ‰€å±ãƒ»å½¹è·</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">éƒ¨ç½²</div>
                            <div style="font-weight: 600;">${dept.emoji} ${dept.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${dept.description}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">å½¹è·</div>
                            <div style="font-weight: 600;">${position.emoji} ${position.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${position.description}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <button onclick="showDepartmentChangeModal(game.employees.find(e => e.id === ${employee.id}))"
                                class="btn-secondary">
                            ğŸ¢ éƒ¨ç½²ç•°å‹•
                        </button>
                        <button onclick="showSkillTreeModal(game.employees.find(e => e.id === ${employee.id}))"
                                class="btn-secondary" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border-color: rgba(102, 126, 234, 0.5);">
                            ğŸŒ³ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ ${(employee.skillPoints || 0) > 0 ? `<strong style="color: #667eea;">(${employee.skillPoints}SP)</strong>` : ''}
                        </button>
                        ${canPromoteNow ? `
                            <button onclick="promoteEmployee(${employee.id})"
                                    class="btn-primary" style="grid-column: 1 / -1;">
                                â­ æ˜‡é€²ã•ã›ã‚‹
                            </button>
                        ` : `
                            <button disabled class="btn-secondary" style="grid-column: 1 / -1; opacity: 0.5;">
                                ğŸ”’ æ˜‡é€²ä¸å¯
                            </button>
                        `}
                    </div>
                    ${!canPromoteNow && employee.position !== 'director' ? `
                        <div style="font-size: 11px; color: #999; margin-top: 8px; text-align: center;">
                            ğŸ’¡ å¹³å‡èƒ½åŠ›${POSITIONS[['senior', 'manager', 'director'][['staff', 'senior', 'manager'].indexOf(employee.position) + 1]]?.requiredAbility || 100}ä»¥ä¸Šã§æ˜‡é€²å¯èƒ½
                        </div>
                    ` : ''}
                </div>
            `;

            // æˆé•·å±¥æ­´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
            const historyHtml = `
                <div class="growth-timeline">
                    <div class="timeline-title">
                        ğŸ“ˆ æˆé•·å±¥æ­´
                    </div>
                    ${(employee.growthHistory || []).map(history => `
                        <div class="timeline-item">
                            <div class="timeline-turn">ç¬¬${history.turn}é€±</div>
                            <div class="timeline-event">${escapeHtml(history.event)}</div>
                            <div class="timeline-description">${escapeHtml(history.description)}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            const modalBody = headerHtml + personalityEffectsHtml + qualificationSectionHtml + traitsHtml + radarHtml + temperamentHtml + deptPositionHtml + historyHtml;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('modalTitle').textContent = 'ğŸ‘¤ å¾“æ¥­å“¡è©³ç´°';
            document.getElementById('modalBody').innerHTML = modalBody;
            const modalEl = document.getElementById('modal');
            modalEl.classList.add('active', 'employee-detail-modal');

            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ï¼ˆDOMãŒæ›´æ–°ã•ã‚ŒãŸå¾Œï¼‰
            setTimeout(() => {
                renderEmployeeRadarChart(employee);
            }, 50);
        }

        function renderEmployeeRadarChart(employee) {
            const canvas = document.getElementById('employeeRadarChart');
            if (!canvas) return;

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (employeeRadarChart) {
                employeeRadarChart.destroy();
                employeeRadarChart = null;
            }

            employeeRadarChart = new Chart(canvas, {
                type: 'radar',
                data: {
                    labels: ['æŠ€è¡“åŠ›', 'å–¶æ¥­åŠ›', 'ä¼ç”»åŠ›', 'ç®¡ç†åŠ›'],
                    datasets: [{
                        label: 'èƒ½åŠ›å€¤',
                        data: [
                            employee.abilities.technical,
                            employee.abilities.sales,
                            employee.abilities.planning,
                            employee.abilities.management
                        ],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // XSSå¯¾ç­–ç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’å…¬é–‹ï¼ˆHTMLã®onclickã§ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
        // TypeScriptã®å‹å®‰å…¨æ€§ã‚’ä¿ã¡ã¤ã¤ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 

        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆHTMLã‹ã‚‰å‚ç…§å¯èƒ½ã«ã™ã‚‹ï¼‰
        (window as any).game = game;

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ åˆ¶å¾¡
        (window as any).init = init;
        (window as any).initWithSlot = initWithSlot; // Phase 2B: ã‚¹ãƒ­ãƒƒãƒˆæŒ‡å®šåˆæœŸåŒ–
        (window as any).saveGame = saveGame;
        (window as any).restartGame = restartGame;
        (window as any).nextTurn = nextTurn;
        (window as any).initAnimationSystem = initAnimationSystem;
        (window as any).syncEmployeeAnimations = syncEmployeeAnimations;

        // ãƒ‘ãƒãƒ«ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        (window as any).showPanel = showPanel;
        (window as any).closeModal = closeModal;

        // äººäº‹ç®¡ç†
        (window as any).showHiring = showHiring;
        (window as any).showDepartmentSelectionForHiring = showDepartmentSelectionForHiring;
        (window as any).showHiringForDepartment = showHiringForDepartment;
        (window as any).hireSelectedCandidate = hireSelectedCandidate;
        (window as any).trainEmployees = trainEmployees;
        (window as any).executeTraining = executeTraining;
        (window as any).promoteEmployee = promoteEmployee;
        (window as any).showEmployeeDetail = showEmployeeDetail;
        (window as any).changeDepartment = changeDepartment;
        (window as any).showDepartmentChangeModal = showDepartmentChangeModal;

        // ã‚¹ã‚­ãƒ«ãƒ»æ€§æ ¼ãƒ»ç‰¹æ€§ã‚·ã‚¹ãƒ†ãƒ 
        (window as any).showSkillTreeModal = showSkillTreeModal;
        (window as any).switchSkillCategory = switchSkillCategory;
        (window as any).unlockSkill = unlockSkill;
        (window as any).showPersonalityDetail = showPersonalityDetail;
        (window as any).showTraitDetail = showTraitDetail;

        // è£½å“é–‹ç™ºãƒ»å¸‚å ´ãƒ»è²¡å‹™
        (window as any).developProduct = developProduct;
        (window as any).doMarketing = doMarketing;
        (window as any).executeMarketing = executeMarketing;
        (window as any).getLoan = getLoan;
        (window as any).repayLoan = repayLoan;
